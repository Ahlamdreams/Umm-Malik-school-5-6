<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الطابور المدرسي - نظام إدارة متكامل</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        /* Advanced Animated Background */
        body {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe, #a8edea, #fed6e3, #d299c2, #fef9d7, #ebc0fd, #d6ecd2);
            background-size: 400% 400%;
            animation: gradientShift 12s ease infinite;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
            animation: backgroundPulse 8s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes backgroundPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Advanced Floating Elements */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Glowing Orbs */
        .glowing-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(1px);
            animation: floatOrb 15s infinite ease-in-out;
        }
        
        .glowing-orb:nth-child(1) { 
            width: 20px; height: 20px; left: 10%; top: 20%;
            background: radial-gradient(circle, #ff6b6b, transparent);
            animation-delay: 0s; animation-duration: 12s;
        }
        .glowing-orb:nth-child(2) { 
            width: 15px; height: 15px; left: 80%; top: 10%;
            background: radial-gradient(circle, #4ecdc4, transparent);
            animation-delay: 2s; animation-duration: 18s;
        }
        .glowing-orb:nth-child(3) { 
            width: 25px; height: 25px; left: 60%; top: 70%;
            background: radial-gradient(circle, #45b7d1, transparent);
            animation-delay: 4s; animation-duration: 14s;
        }
        .glowing-orb:nth-child(4) { 
            width: 18px; height: 18px; left: 30%; top: 80%;
            background: radial-gradient(circle, #feca57, transparent);
            animation-delay: 6s; animation-duration: 16s;
        }
        .glowing-orb:nth-child(5) { 
            width: 22px; height: 22px; left: 90%; top: 50%;
            background: radial-gradient(circle, #ff9ff3, transparent);
            animation-delay: 8s; animation-duration: 20s;
        }
        
        /* Sparkling Stars */
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            animation: sparkleMove 30s infinite linear;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
        }
        
        .sparkle:nth-child(6) { left: 15%; animation-delay: 0s; }
        .sparkle:nth-child(7) { left: 25%; animation-delay: 4s; }
        .sparkle:nth-child(8) { left: 35%; animation-delay: 8s; }
        .sparkle:nth-child(9) { left: 45%; animation-delay: 12s; }
        .sparkle:nth-child(10) { left: 55%; animation-delay: 16s; }
        .sparkle:nth-child(11) { left: 65%; animation-delay: 20s; }
        .sparkle:nth-child(12) { left: 75%; animation-delay: 24s; }
        .sparkle:nth-child(13) { left: 85%; animation-delay: 28s; }
        
        /* Floating Stars */
        .floating-star {
            position: absolute;
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            animation: starFloat 20s infinite ease-in-out;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
        }
        
        .floating-star:nth-child(14) { left: 10%; top: 15%; animation-delay: 0s; }
        .floating-star:nth-child(15) { left: 30%; top: 25%; animation-delay: 3s; }
        .floating-star:nth-child(16) { left: 50%; top: 10%; animation-delay: 6s; }
        .floating-star:nth-child(17) { left: 70%; top: 30%; animation-delay: 9s; }
        .floating-star:nth-child(18) { left: 90%; top: 20%; animation-delay: 12s; }
        .floating-star:nth-child(19) { left: 20%; top: 60%; animation-delay: 15s; }
        .floating-star:nth-child(20) { left: 80%; top: 70%; animation-delay: 18s; }
        
        /* Floating Icons */
        .floating-icon-bg {
            position: absolute;
            font-size: 20px;
            opacity: 0.3;
            animation: iconFloat 25s infinite ease-in-out;
        }
        
        .floating-icon-bg:nth-child(21) { left: 5%; top: 40%; animation-delay: 0s; }
        .floating-icon-bg:nth-child(22) { left: 95%; top: 45%; animation-delay: 5s; }
        .floating-icon-bg:nth-child(23) { left: 15%; top: 80%; animation-delay: 10s; }
        .floating-icon-bg:nth-child(24) { left: 85%; top: 85%; animation-delay: 15s; }
        .floating-icon-bg:nth-child(25) { left: 45%; top: 75%; animation-delay: 20s; }
        
        /* Geometric Shapes */
        .geometric-shape {
            position: absolute;
            animation: geometricFloat 20s infinite ease-in-out;
        }
        
        .triangle {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid rgba(255, 107, 107, 0.3);
            left: 20%; top: 30%;
            animation-delay: 0s;
        }
        
        .square {
            width: 12px;
            height: 12px;
            background: rgba(78, 205, 196, 0.3);
            left: 70%; top: 60%;
            animation-delay: 5s;
            transform: rotate(45deg);
        }
        
        .hexagon {
            width: 16px;
            height: 14px;
            background: rgba(69, 183, 209, 0.3);
            position: relative;
            left: 40%; top: 15%;
            animation-delay: 10s;
        }
        
        .hexagon:before {
            content: "";
            position: absolute;
            top: -7px;
            left: 0;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 7px solid rgba(69, 183, 209, 0.3);
        }
        
        .hexagon:after {
            content: "";
            position: absolute;
            bottom: -7px;
            left: 0;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 7px solid rgba(69, 183, 209, 0.3);
        }
        
        @keyframes floatOrb {
            0%, 100% { transform: translateY(0px) translateX(0px) scale(1); opacity: 0.7; }
            25% { transform: translateY(-30px) translateX(20px) scale(1.1); opacity: 1; }
            50% { transform: translateY(-10px) translateX(-15px) scale(0.9); opacity: 0.8; }
            75% { transform: translateY(-40px) translateX(10px) scale(1.05); opacity: 0.9; }
        }
        
        @keyframes sparkleMove {
            0% { transform: translateY(100vh) translateX(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) translateX(50px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes starFloat {
            0%, 100% { 
                transform: translateY(0px) translateX(0px) rotate(0deg) scale(1); 
                opacity: 0.6; 
            }
            25% { 
                transform: translateY(-20px) translateX(15px) rotate(90deg) scale(1.2); 
                opacity: 1; 
            }
            50% { 
                transform: translateY(-10px) translateX(-10px) rotate(180deg) scale(0.8); 
                opacity: 0.8; 
            }
            75% { 
                transform: translateY(-30px) translateX(20px) rotate(270deg) scale(1.1); 
                opacity: 0.9; 
            }
        }
        
        @keyframes iconFloat {
            0%, 100% { 
                transform: translateY(0px) translateX(0px) rotate(0deg) scale(1); 
                opacity: 0.2; 
            }
            33% { 
                transform: translateY(-40px) translateX(25px) rotate(120deg) scale(1.3); 
                opacity: 0.4; 
            }
            66% { 
                transform: translateY(-15px) translateX(-20px) rotate(240deg) scale(0.7); 
                opacity: 0.3; 
            }
        }
        
        @keyframes geometricFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.6; }
            25% { transform: translateY(-50px) rotate(90deg); opacity: 0.8; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
            75% { transform: translateY(-35px) rotate(270deg); opacity: 0.7; }
        }
        
        /* Glass morphism effects */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 2;
        }
        
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }
        
        .gradient-bg {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
        }
        
        /* Interactive hover effects */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .card-hover:hover::before {
            left: 100%;
        }
        
        .card-hover:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        /* Enhanced status cards */
        .present-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .absent-card {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .late-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.9), rgba(217, 119, 6, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .excuse-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9), rgba(124, 58, 237, 0.9));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        /* Animated icons */
        .icon-bounce {
            animation: iconBounce 2s ease-in-out infinite;
        }
        
        @keyframes iconBounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .icon-rotate {
            animation: iconRotate 4s linear infinite;
        }
        
        @keyframes iconRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .icon-pulse {
            animation: iconPulse 2s ease-in-out infinite;
        }
        
        @keyframes iconPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced star glow */
        .star-glow {
            animation: starGlow 3s ease-in-out infinite alternate;
            position: relative;
        }
        
        .star-glow::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            border-radius: 50%;
            animation: starPulse 3s ease-in-out infinite;
        }
        
        @keyframes starGlow {
            from { 
                text-shadow: 0 0 10px #fbbf24, 0 0 20px #fbbf24, 0 0 30px #fbbf24;
                transform: scale(1);
            }
            to { 
                text-shadow: 0 0 20px #fbbf24, 0 0 30px #fbbf24, 0 0 40px #fbbf24, 0 0 50px #fbbf24;
                transform: scale(1.05);
            }
        }
        
        @keyframes starPulse {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.2); }
        }

        /* Enhanced Mouse Trail Effect */
        .mouse-trail {
            position: fixed;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.8) 0%, rgba(78, 205, 196, 0.6) 30%, rgba(69, 183, 209, 0.4) 60%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            mix-blend-mode: screen;
            animation: trailFade 1.2s ease-out forwards;
            filter: blur(0.5px);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        @keyframes trailFade {
            0% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.2) rotate(360deg);
            }
        }

        /* Enhanced Click Ripple Effect */
        .click-ripple {
            position: fixed;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 159, 243, 0.7) 0%, rgba(84, 160, 255, 0.5) 20%, rgba(16, 172, 132, 0.3) 40%, transparent 70%);
            pointer-events: none;
            z-index: 9998;
            animation: rippleExpand 1.2s ease-out forwards;
            filter: blur(1px);
        }

        @keyframes rippleExpand {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
                transform: scale(0) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: scale(0.5) rotate(180deg);
            }
            100% {
                width: 400px;
                height: 400px;
                opacity: 0;
                transform: scale(1) rotate(360deg);
            }
        }

        /* Interactive Color Change Effect */
        .color-change-zone {
            position: fixed;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: colorPulse 2s ease-in-out infinite;
            mix-blend-mode: overlay;
        }

        @keyframes colorPulse {
            0%, 100% {
                transform: scale(1);
                background: radial-gradient(circle, rgba(255, 107, 107, 0.2) 0%, transparent 70%);
            }
            25% {
                transform: scale(1.1);
                background: radial-gradient(circle, rgba(78, 205, 196, 0.2) 0%, transparent 70%);
            }
            50% {
                transform: scale(1.2);
                background: radial-gradient(circle, rgba(69, 183, 209, 0.2) 0%, transparent 70%);
            }
            75% {
                transform: scale(1.1);
                background: radial-gradient(circle, rgba(254, 202, 87, 0.2) 0%, transparent 70%);
            }
        }

        /* Enhanced Interactive Elements */
        .interactive-element {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .interactive-element::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .interactive-element:hover::before {
            left: 100%;
        }

        .interactive-element:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        /* Floating Animation for Icons */
        .floating-icon {
            animation: floatingIcon 3s ease-in-out infinite;
        }

        @keyframes floatingIcon {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(2deg); }
            50% { transform: translateY(-5px) rotate(-1deg); }
            75% { transform: translateY(-15px) rotate(1deg); }
        }

        /* Glow Effect on Hover */
        .glow-on-hover {
            transition: all 0.3s ease;
        }

        .glow-on-hover:hover {
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 0 40px rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        /* Smooth Gradient Animations */
        .gradient-animation {
            background-size: 200% 200%;
            animation: gradientMove 4s ease infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Enhanced Button Interactions */
        .modern-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        }

        .modern-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .modern-button:hover::after {
            width: 300px;
            height: 300px;
        }

        .modern-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        /* Pulse Animation for Important Elements */
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.6), 0 0 30px rgba(255, 255, 255, 0.4);
            }
        }

        /* Smooth Transitions for All Elements */
        * {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* Enhanced Card Hover Effects */
        .enhanced-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .enhanced-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: cardRotate 4s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .enhanced-card:hover::before {
            opacity: 1;
        }

        @keyframes cardRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .enhanced-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 1024px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .text-7xl {
                font-size: 3rem;
            }
            
            .text-5xl {
                font-size: 2.5rem;
            }
        }

        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .enhanced-card:hover {
                transform: translateY(-2px) scale(1.01);
            }
            
            .floating-icon {
                animation-duration: 2s;
            }
            
            .mouse-trail {
                width: 10px;
                height: 10px;
            }
            
            .click-ripple {
                animation-duration: 0.6s;
            }
            
            /* Header adjustments */
            header {
                padding: 2rem 0;
            }
            
            .text-7xl {
                font-size: 2.5rem;
            }
            
            .text-5xl {
                font-size: 2rem;
            }
            
            .text-4xl {
                font-size: 1.8rem;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .text-2xl {
                font-size: 1.25rem;
            }
            
            /* Navigation improvements */
            nav {
                padding: 0.5rem 0;
            }
            
            .nav-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                margin: 0.25rem;
            }
            
            /* Grid adjustments */
            .grid {
                gap: 1rem;
            }
            
            .grid-cols-1 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .md\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .md\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .md\:grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            .lg\:grid-cols-3 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            .xl\:grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            /* Card improvements */
            .glass-card {
                padding: 1rem;
                margin: 0.5rem 0;
            }
            
            /* Modal improvements */
            .modal > div {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
            
            /* Table responsiveness */
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 0.25rem;
            }
            
            /* Form improvements */
            input, select, button {
                font-size: 1rem;
                padding: 0.75rem;
            }
            
            /* Certificate adjustments */
            .certificate {
                padding: 1.5rem;
                font-size: 0.875rem;
            }
        }

        @media (max-width: 640px) {
            .enhanced-card:hover {
                transform: translateY(-1px);
            }
            
            .glass-card {
                backdrop-filter: blur(8px);
                padding: 0.75rem;
            }
            
            .floating-particles {
                display: none;
            }
            
            /* Ultra-mobile adjustments */
            .text-7xl {
                font-size: 2rem;
            }
            
            .text-5xl {
                font-size: 1.75rem;
            }
            
            .text-4xl {
                font-size: 1.5rem;
            }
            
            .text-3xl {
                font-size: 1.25rem;
            }
            
            .text-2xl {
                font-size: 1.125rem;
            }
            
            .text-xl {
                font-size: 1rem;
            }
            
            .text-lg {
                font-size: 0.875rem;
            }
            
            /* Navigation for small screens */
            nav .flex {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .nav-btn {
                width: 100%;
                text-align: center;
                padding: 0.75rem;
            }
            
            /* Statistics cards */
            .md\:grid-cols-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            
            /* Admin tabs */
            .admin-tab-btn {
                width: 100%;
                margin: 0.25rem 0;
                font-size: 0.875rem;
            }
            
            /* Form elements */
            .grid.grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
            
            /* Header logos */
            .w-32.h-32 {
                width: 4rem;
                height: 4rem;
            }
            
            .w-24.h-24 {
                width: 3rem;
                height: 3rem;
            }
            
            /* Certificate modal */
            .certificate {
                padding: 1rem;
                font-size: 0.75rem;
            }
            
            .certificate .text-4xl {
                font-size: 1.5rem;
            }
            
            .certificate .text-3xl {
                font-size: 1.25rem;
            }
            
            .certificate .text-2xl {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            /* Extra small screens */
            body {
                font-size: 12px;
            }
            
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            header {
                padding: 1.5rem 0;
            }
            
            .glass-card {
                padding: 0.5rem;
                margin: 0.25rem 0;
            }
            
            /* Minimum touch targets */
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Single column layout */
            .grid {
                grid-template-columns: repeat(1, minmax(0, 1fr));
                gap: 0.5rem;
            }
            
            /* Navigation stack */
            nav .flex {
                flex-direction: column;
                gap: 0.25rem;
            }
            
            /* Header adjustments */
            .text-7xl {
                font-size: 1.75rem;
            }
            
            .text-5xl {
                font-size: 1.5rem;
            }
            
            .text-4xl {
                font-size: 1.25rem;
            }
            
            .text-3xl {
                font-size: 1.125rem;
            }
            
            .text-2xl {
                font-size: 1rem;
            }
            
            .text-xl {
                font-size: 0.875rem;
            }
            
            .text-lg {
                font-size: 0.75rem;
            }
            
            /* Logo sizes */
            .w-32.h-32 {
                width: 3rem;
                height: 3rem;
            }
            
            .w-24.h-24 {
                width: 2.5rem;
                height: 2.5rem;
            }
            
            .w-20.h-20 {
                width: 2rem;
                height: 2rem;
            }
            
            .w-16.h-16 {
                width: 1.5rem;
                height: 1.5rem;
            }
            
            /* Modal full screen */
            .modal > div {
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
                max-height: calc(100vh - 1rem);
                overflow-y: auto;
            }
            
            /* Table scroll */
            table {
                font-size: 0.625rem;
                min-width: 100%;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .enhanced-card:hover {
                transform: none;
            }
            
            .card-hover:hover {
                transform: none;
            }
            
            .glow-on-hover:hover {
                box-shadow: none;
                transform: none;
            }
            
            /* Remove hover effects on touch devices */
            .nav-btn:hover::after {
                width: 0;
            }
            
            .modern-button:hover::after {
                width: 0;
                height: 0;
            }
            
            .stat-card:hover::before {
                left: -100%;
            }
            
            /* Ensure touch targets are large enough */
            button, .nav-btn, .admin-tab-btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }
            
            /* Disable complex animations on touch devices */
            .floating-icon {
                animation: none;
            }
            
            .icon-bounce, .icon-rotate, .icon-pulse {
                animation: none;
            }
        }

        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            header {
                padding: 1rem 0;
            }
            
            .text-7xl {
                font-size: 2rem;
            }
            
            .text-5xl {
                font-size: 1.75rem;
            }
            
            .grid-cols-1.md\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
            
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .glass-card {
                backdrop-filter: blur(15px);
            }
            
            .mouse-trail {
                filter: blur(0.25px);
            }
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .floating-particles {
                display: none;
            }
            
            .mouse-trail, .click-ripple {
                display: none;
            }
        }
        
        /* Interactive buttons */
        .btn-interactive {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-interactive::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn-interactive:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-interactive:active {
            transform: scale(0.95);
        }
        
        /* Modal enhancements */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Certificate with enhanced effects */
        .certificate {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            border: 8px solid #d97706;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .certificate::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: shine 3s linear infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        /* Navigation enhancements */
        .nav-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.8);
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }
        
        .nav-btn:hover::after {
            width: 100%;
        }
        
        /* Statistics cards enhancement */
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .stat-card:hover::before {
            left: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Advanced Floating Elements -->
    <div class="floating-particles">
        <!-- Glowing Orbs -->
        <div class="glowing-orb"></div>
        <div class="glowing-orb"></div>
        <div class="glowing-orb"></div>
        <div class="glowing-orb"></div>
        <div class="glowing-orb"></div>
        
        <!-- Sparkling Particles -->
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        <div class="sparkle"></div>
        
        <!-- Floating Stars -->
        <div class="floating-star">⭐</div>
        <div class="floating-star">✨</div>
        <div class="floating-star">🌟</div>
        <div class="floating-star">⭐</div>
        <div class="floating-star">✨</div>
        <div class="floating-star">🌟</div>
        <div class="floating-star">⭐</div>
        
        <!-- Floating Icons -->
        <div class="floating-icon-bg">📚</div>
        <div class="floating-icon-bg">🎓</div>
        <div class="floating-icon-bg">📝</div>
        <div class="floating-icon-bg">🏫</div>
        <div class="floating-icon-bg">👩‍🏫</div>
        
        <!-- Geometric Shapes -->
        <div class="geometric-shape triangle"></div>
        <div class="geometric-shape square"></div>
        <div class="geometric-shape hexagon"></div>
    </div>

    <!-- Header -->
    <header class="gradient-bg text-gray-800 py-20 shadow-2xl relative overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 20%, #f093fb 40%, #a8edea 60%, #d6ecd2 80%, #fef9d7 100%); background-size: 400% 400%; animation: gradientShift 15s ease infinite;">
        <!-- Enhanced Decorative Elements with Better Integration -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden">
            <!-- Background Geometric Patterns -->
            <div class="absolute top-8 left-8 w-32 h-32 border-2 border-white opacity-15 rounded-full animate-pulse"></div>
            <div class="absolute top-12 right-12 w-24 h-24 border-2 border-yellow-300 opacity-20 rounded-lg rotate-45 animate-spin" style="animation-duration: 20s;"></div>
            <div class="absolute bottom-16 left-1/4 w-20 h-20 border-2 border-pink-300 opacity-15 rounded-full animate-bounce"></div>
            <div class="absolute bottom-20 right-1/3 w-28 h-28 border-2 border-blue-300 opacity-18 rounded-lg rotate-12 animate-pulse"></div>
            
            <!-- Integrated Floating Stars - Positioned around content -->
            <div class="absolute top-16 left-16 text-2xl text-yellow-400 opacity-95 floating-star">⭐</div>
            <div class="absolute top-20 right-24 text-xl text-yellow-300 opacity-90 floating-star" style="animation-delay: 1s;">✨</div>
            <div class="absolute top-32 left-1/2 transform -translate-x-1/2 text-3xl text-yellow-400 opacity-95 floating-star" style="animation-delay: 2s;">🌟</div>
            <div class="absolute top-24 left-1/3 text-xl text-yellow-300 opacity-90 floating-star" style="animation-delay: 3s;">⭐</div>
            <div class="absolute top-28 right-1/3 text-2xl text-yellow-400 opacity-95 floating-star" style="animation-delay: 4s;">✨</div>
            
            <!-- Stars around logos area -->
            <div class="absolute top-40 left-40 text-lg text-yellow-300 opacity-90 floating-star" style="animation-delay: 5s;">🌟</div>
            <div class="absolute top-40 right-40 text-lg text-yellow-400 opacity-95 floating-star" style="animation-delay: 6s;">⭐</div>
            
            <!-- Stars around bottom section -->
            <div class="absolute bottom-32 left-20 text-xl text-yellow-300 opacity-90 floating-star" style="animation-delay: 7s;">✨</div>
            <div class="absolute bottom-28 right-20 text-2xl text-yellow-400 opacity-95 floating-star" style="animation-delay: 8s;">🌟</div>
            <div class="absolute bottom-36 left-1/2 transform -translate-x-1/2 text-lg text-yellow-400 opacity-95 floating-star" style="animation-delay: 9s;">⭐</div>
            
            <!-- Educational Icons - Strategically placed -->
            <div class="absolute top-44 left-1/4 text-xl text-blue-200 opacity-50 floating-icon-bg" style="animation-delay: 1s;">📚</div>
            <div class="absolute top-48 right-1/4 text-2xl text-green-200 opacity-60 floating-icon-bg" style="animation-delay: 2s;">🎓</div>
            <div class="absolute bottom-44 left-1/3 text-xl text-purple-200 opacity-55 floating-icon-bg" style="animation-delay: 3s;">📝</div>
            <div class="absolute bottom-40 right-1/3 text-2xl text-yellow-200 opacity-65 floating-icon-bg" style="animation-delay: 4s;">🏫</div>
            <div class="absolute top-1/2 left-20 text-lg text-pink-200 opacity-50 floating-icon-bg" style="animation-delay: 5s;">👩‍🏫</div>
            <div class="absolute top-1/2 right-20 text-lg text-blue-300 opacity-60 floating-icon-bg" style="animation-delay: 6s;">📖</div>
            
            <!-- Subtle Geometric Accents -->
            <div class="absolute top-20 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-white opacity-30 rotate-45 animate-spin" style="animation-duration: 8s;"></div>
            <div class="absolute top-52 right-1/4 w-4 h-4 bg-yellow-300 opacity-40 rounded-full animate-bounce" style="animation-delay: 2s;"></div>
            <div class="absolute bottom-24 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-pink-300 opacity-35 rotate-12 animate-pulse" style="animation-delay: 3s;"></div>
            <div class="absolute top-1/3 left-12 w-2 h-2 bg-blue-300 opacity-40 rounded-full animate-ping" style="animation-delay: 4s;"></div>
            <div class="absolute bottom-1/3 right-12 w-3 h-3 bg-purple-300 opacity-30 rotate-45 animate-spin" style="animation-duration: 12s; animation-delay: 1s;"></div>
            
            <!-- Corner Accent Stars -->
            <div class="absolute top-8 left-8 text-sm text-yellow-400 opacity-85 floating-star" style="animation-delay: 10s;">⭐</div>
            <div class="absolute top-8 right-8 text-sm text-yellow-300 opacity-80 floating-star" style="animation-delay: 11s;">✨</div>
            <div class="absolute bottom-8 left-8 text-sm text-yellow-400 opacity-85 floating-star" style="animation-delay: 12s;">🌟</div>
            <div class="absolute bottom-8 right-8 text-sm text-yellow-300 opacity-80 floating-star" style="animation-delay: 13s;">⭐</div>
        </div>
        
        <div class="container mx-auto px-6 relative z-10">
            <!-- Top section with logos -->
            <div class="flex flex-col lg:flex-row justify-between items-center lg:items-start mb-8 lg:mb-12 space-y-6 lg:space-y-0">
                <!-- Logos Container for Mobile -->
                <div class="flex justify-center space-x-8 space-x-reverse lg:hidden w-full">
                    <!-- Left Logo Mobile -->
                    <div class="w-24 h-24 bg-white bg-opacity-15 rounded-2xl flex items-center justify-center floating-icon glow-on-hover interactive-element border-2 border-white border-opacity-30 backdrop-filter backdrop-blur-lg">
                        <img id="left-logo-mobile" src="" alt="الشعار الأيسر" class="w-16 h-16 object-contain rounded-xl" style="display: none;">
                        <div id="left-logo-placeholder-mobile" class="text-center">
                            <div class="text-2xl mb-1">🏫</div>
                            <div class="text-xs opacity-75">الشعار الأيسر</div>
                        </div>
                    </div>
                    
                    <!-- Right Logo Mobile -->
                    <div class="w-24 h-24 bg-white bg-opacity-15 rounded-2xl flex items-center justify-center floating-icon glow-on-hover interactive-element border-2 border-white border-opacity-30 backdrop-filter backdrop-blur-lg" style="animation-delay: 0.5s;">
                        <img id="right-logo-mobile" src="" alt="الشعار الأيمن" class="w-16 h-16 object-contain rounded-xl" style="display: none;">
                        <div id="right-logo-placeholder-mobile" class="text-center">
                            <div class="text-2xl mb-1">🎓</div>
                            <div class="text-xs opacity-75">الشعار الأيمن</div>
                        </div>
                    </div>
                </div>
                
                <!-- Left Logo Desktop -->
                <div class="hidden lg:block w-32 h-32 bg-white bg-opacity-15 rounded-2xl flex items-center justify-center floating-icon glow-on-hover interactive-element border-2 border-white border-opacity-30 backdrop-filter backdrop-blur-lg">
                    <img id="left-logo" src="" alt="الشعار الأيسر" class="w-24 h-24 object-contain rounded-xl" style="display: none;">
                    <div id="left-logo-placeholder" class="text-center">
                        <div class="text-3xl mb-2">🏫</div>
                        <div class="text-xs opacity-75">الشعار الأيسر</div>
                    </div>
                </div>
                
                <!-- Center Title -->
                <div class="text-center flex-1 lg:mx-8">
                    <div class="mb-4 lg:mb-6">
                        <div class="inline-block bg-white bg-opacity-10 px-4 lg:px-8 py-2 lg:py-3 rounded-full border border-white border-opacity-30 backdrop-filter backdrop-blur-lg mb-3 lg:mb-4">
                            <span class="text-sm lg:text-lg font-semibold opacity-90">نظام إدارة الطابور المدرسي</span>
                        </div>
                    </div>
                    <h1 class="text-4xl md:text-5xl lg:text-7xl font-black mb-4 lg:mb-6 tracking-wider text-shadow-lg">الطابور المدرسي</h1>
                    <div class="flex justify-center items-center mb-4 lg:mb-6">
                        <div class="w-12 lg:w-16 h-0.5 lg:h-1 bg-white rounded-full opacity-60"></div>
                        <div class="w-3 lg:w-4 h-3 lg:h-4 bg-white rounded-full mx-3 lg:mx-4 opacity-80"></div>
                        <div class="w-12 lg:w-16 h-0.5 lg:h-1 bg-white rounded-full opacity-60"></div>
                    </div>
                    <p class="text-lg md:text-xl lg:text-2xl font-light opacity-95 max-w-4xl mx-auto leading-relaxed px-4">
                        انضباط يعكس وعيًا ونظام يصنع الأجيال
                    </p>
                </div>
                
                <!-- Right Logo Desktop -->
                <div class="hidden lg:block w-32 h-32 bg-white bg-opacity-15 rounded-2xl flex items-center justify-center floating-icon glow-on-hover interactive-element border-2 border-white border-opacity-30 backdrop-filter backdrop-blur-lg" style="animation-delay: 0.5s;">
                    <img id="right-logo" src="" alt="الشعار الأيمن" class="w-24 h-24 object-contain rounded-xl" style="display: none;">
                    <div id="right-logo-placeholder" class="text-center">
                        <div class="text-3xl mb-2">🎓</div>
                        <div class="text-xs opacity-75">الشعار الأيمن</div>
                    </div>
                </div>
            </div>
            
            <!-- Principal Info Section -->
            <div class="mb-4 lg:mb-6">
                <div class="bg-gradient-to-r from-purple-600/30 via-pink-500/30 to-indigo-600/30 rounded-3xl p-4 lg:p-6 backdrop-filter backdrop-blur-xl border-2 border-white border-opacity-40 text-center max-w-2xl mx-auto shadow-2xl">
                    <div class="flex items-center justify-center mb-2">
                        <div class="w-12 h-12 bg-white bg-opacity-25 rounded-full flex items-center justify-center mr-4 shadow-lg">
                            <span class="text-2xl">👑</span>
                        </div>
                        <div>
                            <div class="text-lg font-bold text-white opacity-95 mb-1">مديرة المدرسة</div>
                            <div id="principal-display" class="text-2xl font-black text-white drop-shadow-lg">${settings.principalName}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Date Time Section -->
            <div class="mb-6 lg:mb-8">
                <div class="bg-white bg-opacity-15 rounded-2xl p-3 lg:p-4 backdrop-filter backdrop-blur-lg border border-white border-opacity-25 text-center max-w-md mx-auto">
                    <div class="flex items-center justify-center">
                        <span class="text-xl mr-3">🕐</span>
                        <div>
                            <div class="text-sm font-semibold opacity-90 mb-1">التاريخ والوقت</div>
                            <div id="current-datetime" class="text-lg font-bold opacity-95">جاري التحميل...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom section with stars display -->
            <div class="flex flex-wrap justify-center gap-4 lg:gap-6">
                <!-- Stars Display - Enhanced -->
                <div class="bg-gradient-to-br from-yellow-400/30 via-amber-300/25 to-orange-400/30 rounded-3xl p-4 lg:p-5 backdrop-filter backdrop-blur-xl border-2 border-yellow-300 border-opacity-40 text-center min-w-[180px] shadow-2xl transform hover:scale-105 transition-all duration-300 enhanced-card">
                    <div class="flex items-center justify-center mb-2">
                        <span class="text-2xl lg:text-3xl icon-rotate mr-2 drop-shadow-lg">⭐</span>
                        <h3 class="text-sm lg:text-base font-black text-white drop-shadow-md">🌟 نجمة اليوم 🌟</h3>
                    </div>
                    <div id="star-of-day-header" class="text-sm lg:text-base star-glow font-bold text-white drop-shadow-lg bg-black bg-opacity-20 rounded-xl px-3 py-2 mb-2">لم يتم اختيار نجمة اليوم بعد</div>
                    <div class="text-xs lg:text-sm text-white opacity-90 font-semibold">المعلمة المتميزة اليوم</div>
                </div>
                
                <div class="bg-gradient-to-br from-blue-500/30 via-indigo-400/25 to-purple-500/30 rounded-3xl p-4 lg:p-5 backdrop-filter backdrop-blur-xl border-2 border-blue-300 border-opacity-40 text-center min-w-[180px] shadow-2xl transform hover:scale-105 transition-all duration-300 enhanced-card">
                    <div class="flex items-center justify-center mb-2">
                        <span class="text-2xl lg:text-3xl icon-bounce mr-2 drop-shadow-lg">🏆</span>
                        <h3 class="text-sm lg:text-base font-black text-white drop-shadow-md">🏆 نجم الطابور 🏆</h3>
                    </div>
                    <div id="star-of-queue-header" class="text-sm lg:text-base star-glow font-bold text-white drop-shadow-lg bg-black bg-opacity-20 rounded-xl px-3 py-2 mb-2">لم يتم اختيار نجم الطابور بعد</div>
                    <div class="text-xs lg:text-sm text-white opacity-90 font-semibold">الصف الأكثر انضباطاً</div>
                </div>
                
                <div class="bg-gradient-to-br from-pink-500/30 via-rose-400/25 to-red-500/30 rounded-3xl p-4 lg:p-5 backdrop-filter backdrop-blur-xl border-2 border-pink-300 border-opacity-40 text-center min-w-[180px] shadow-2xl transform hover:scale-105 transition-all duration-300 enhanced-card">
                    <div class="flex items-center justify-center mb-2">
                        <span class="text-2xl lg:text-3xl icon-pulse mr-2 drop-shadow-lg">👑</span>
                        <h3 class="text-sm lg:text-base font-black text-white drop-shadow-md">👑 نجمة الشهر 👑</h3>
                    </div>
                    <div id="star-of-month-teacher-header" class="text-sm lg:text-base star-glow font-bold text-white drop-shadow-lg bg-black bg-opacity-20 rounded-xl px-3 py-2 mb-2">لم يتم الاختيار</div>
                    <div class="text-xs lg:text-sm text-white opacity-90 font-semibold">المعلمة المثالية للشهر</div>
                </div>
                
                <div class="bg-gradient-to-br from-green-500/30 via-emerald-400/25 to-teal-500/30 rounded-3xl p-4 lg:p-5 backdrop-filter backdrop-blur-xl border-2 border-green-300 border-opacity-40 text-center min-w-[180px] shadow-2xl transform hover:scale-105 transition-all duration-300 enhanced-card">
                    <div class="flex items-center justify-center mb-2">
                        <span class="text-2xl lg:text-3xl icon-rotate mr-2 drop-shadow-lg">🎖️</span>
                        <h3 class="text-sm lg:text-base font-black text-white drop-shadow-md">🎖️ نجم الطابور للشهر 🎖️</h3>
                    </div>
                    <div id="star-of-queue-month-header" class="text-sm lg:text-base star-glow font-bold text-white drop-shadow-lg bg-black bg-opacity-20 rounded-xl px-3 py-2 mb-2">لم يتم الاختيار</div>
                    <div class="text-xs lg:text-sm text-white opacity-90 font-semibold">الصف المتميز للشهر</div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced bottom wave decoration -->
        <div class="absolute bottom-0 left-0 w-full">
            <svg viewBox="0 0 1200 120" preserveAspectRatio="none" class="w-full h-16 fill-current text-white opacity-25">
                <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z"></path>
            </svg>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md py-4">
        <div class="container mx-auto px-4">
            <div class="flex justify-center space-x-4 space-x-reverse">
                <button onclick="showSection('attendance')" class="nav-btn modern-button interactive-element glow-on-hover bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors glass-card">
                    <span class="floating-icon">👥</span> حضور المعلمات
                </button>
                <button onclick="showSection('stars')" class="nav-btn modern-button interactive-element glow-on-hover bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors glass-card">
                    <span class="floating-icon" style="animation-delay: 0.3s;">⭐</span> نجم الطابور
                </button>
                <button onclick="showSection('admin')" class="nav-btn modern-button interactive-element glow-on-hover bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors glass-card">
                    <span class="floating-icon" style="animation-delay: 0.6s;">⚙️</span> إدارة النظام
                </button>
            </div>
        </div>
    </nav>

    <!-- Attendance Section -->
    <section id="attendance-section" class="container mx-auto px-4 py-8">
        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="enhanced-card interactive-element glow-on-hover pulse-glow text-white p-6 rounded-lg text-center gradient-animation" style="background: linear-gradient(135deg, rgba(52, 211, 153, 0.9), rgba(16, 185, 129, 0.9), rgba(6, 182, 212, 0.9));">
                <div class="text-4xl mb-2 floating-icon">✅</div>
                <div class="text-3xl font-bold" id="present-count">0</div>
                <div class="text-sm">الحاضرات</div>
            </div>
            <div class="enhanced-card interactive-element glow-on-hover pulse-glow text-white p-6 rounded-lg text-center gradient-animation" style="background: linear-gradient(135deg, rgba(251, 113, 133, 0.9), rgba(244, 63, 94, 0.9), rgba(236, 72, 153, 0.9));">
                <div class="text-4xl mb-2 floating-icon" style="animation-delay: 0.2s;">❌</div>
                <div class="text-3xl font-bold" id="absent-count">0</div>
                <div class="text-sm">الغائبات</div>
            </div>
            <div class="enhanced-card interactive-element glow-on-hover pulse-glow text-white p-6 rounded-lg text-center gradient-animation" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.9), rgba(124, 58, 237, 0.9), rgba(168, 85, 247, 0.9));">
                <div class="text-4xl mb-2 floating-icon" style="animation-delay: 0.4s;">⏳</div>
                <div class="text-3xl font-bold" id="pending-count">0</div>
                <div class="text-sm">لم يتم التسجيل</div>
            </div>
            <div class="enhanced-card interactive-element glow-on-hover pulse-glow text-white p-6 rounded-lg text-center gradient-animation" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9), rgba(79, 70, 229, 0.9));">
                <div class="text-4xl mb-2 floating-icon" style="animation-delay: 0.6s;">📊</div>
                <div class="text-3xl font-bold" id="total-count">0</div>
                <div class="text-sm">الإجمالي</div>
            </div>
        </div>



        <!-- Daily Attendance Log -->
        <div class="glass-card rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="text-3xl mr-3 icon-bounce">📝</div>
                <h3 class="text-2xl font-bold text-center text-white">توقيع المعلمات للطابور اليومي</h3>
            </div>
            <div class="text-center text-gray-200 mb-4">التاريخ: <span id="current-date"></span></div>
            <div id="daily-signatures" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Daily signatures will be loaded here -->
            </div>
        </div>

        <!-- Teachers Grid -->
        <div id="teachers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Teachers will be loaded here -->
        </div>
    </section>

    <!-- Stars Section -->
    <section id="stars-section" class="container mx-auto px-4 py-8" style="display: none;">
        <div class="glass-card p-6 rounded-lg mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="text-4xl mr-4 icon-rotate">🏆</div>
                <h2 class="text-3xl font-bold text-center text-white">نجم الطابور - تقييم الصفوف</h2>
            </div>
        </div>
        
        <div id="classes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Classes will be loaded here -->
        </div>
    </section>

    <!-- Admin Section -->
    <section id="admin-section" class="container mx-auto px-4 py-8" style="display: none;">
        <div class="glass-card rounded-lg shadow-lg p-8">
            <div class="flex items-center justify-center mb-8">
                <div class="text-4xl mr-4 icon-bounce">⚙️</div>
                <h2 class="text-3xl font-bold text-center text-white">إدارة النظام</h2>
            </div>
            
            <!-- Admin Tabs -->
            <div class="flex flex-wrap justify-center mb-8 space-x-2 space-x-reverse">
                <button onclick="showAdminTab('teachers')" class="admin-tab-btn btn-interactive bg-blue-500 text-white px-4 py-2 rounded-lg mb-2 glass-card">
                    <span class="icon-pulse">👩‍🏫</span> إدارة المعلمات
                </button>
                <button onclick="showAdminTab('stars-mgmt')" class="admin-tab-btn btn-interactive bg-yellow-500 text-white px-4 py-2 rounded-lg mb-2 glass-card">
                    <span class="icon-rotate">⭐</span> إدارة النجوم
                </button>
                <button onclick="showAdminTab('certificates')" class="admin-tab-btn btn-interactive bg-green-500 text-white px-4 py-2 rounded-lg mb-2 glass-card">
                    <span class="icon-bounce">🏆</span> طباعة الشهادات
                </button>
                <button onclick="showAdminTab('settings')" class="admin-tab-btn btn-interactive bg-purple-500 text-white px-4 py-2 rounded-lg mb-2 glass-card">
                    <span class="icon-pulse">⚙️</span> الإعدادات
                </button>
                <button onclick="showAdminTab('data')" class="admin-tab-btn btn-interactive bg-red-500 text-white px-4 py-2 rounded-lg mb-2 glass-card">
                    <span class="icon-bounce">📊</span> إدارة البيانات
                </button>
            </div>

            <!-- Teachers Management -->
            <div id="admin-teachers" class="admin-tab">
                <h3 class="text-2xl font-bold mb-6">إدارة المعلمات</h3>
                
                <!-- Add Teacher Form -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h4 class="text-lg font-semibold mb-4">إضافة معلمة جديدة</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="teacher-name" placeholder="اسم المعلمة" class="border rounded-lg px-4 py-2">
                        <input type="text" id="teacher-class" placeholder="الصف المشرفة عليه" class="border rounded-lg px-4 py-2">
                    </div>
                    <button onclick="addTeacher()" class="bg-blue-500 text-white px-6 py-2 rounded-lg mt-4 hover:bg-blue-600">إضافة المعلمة</button>
                </div>

                <!-- Excel Upload -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h4 class="text-lg font-semibold mb-4">رفع ملف Excel للمعلمات</h4>
                    <input type="file" id="excel-file" accept=".xlsx,.xls" class="border rounded-lg px-4 py-2 mb-4">
                    <button onclick="uploadExcel()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">رفع ملف المعلمات</button>
                </div>

                <!-- Classes Excel Upload -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h4 class="text-lg font-semibold mb-4">رفع ملف Excel للصفوف</h4>
                    <p class="text-sm text-gray-600 mb-2">يجب أن يحتوي الملف على عمود واحد بأسماء الصفوف</p>
                    <input type="file" id="classes-excel-file" accept=".xlsx,.xls" class="border rounded-lg px-4 py-2 mb-4">
                    <button onclick="uploadClassesExcel()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">رفع ملف الصفوف</button>
                </div>

                <!-- Teachers List -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h4 class="text-lg font-semibold mb-4">قائمة المعلمات</h4>
                    <div id="teachers-list" class="space-y-2">
                        <!-- Teachers list will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Stars Management -->
            <div id="admin-stars-mgmt" class="admin-tab" style="display: none;">
                <h3 class="text-2xl font-bold mb-6">إدارة النجوم</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">نجوم المعلمات</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">نجمة الأسبوع</label>
                                <select id="star-week-teacher" class="w-full border rounded-lg px-4 py-2">
                                    <option value="">اختر المعلمة</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">نجمة الشهر</label>
                                <select id="star-month-teacher" class="w-full border rounded-lg px-4 py-2">
                                    <option value="">اختر المعلمة</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">نجوم الصفوف</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">نجم الطابور</label>
                                <select id="star-queue-class" class="w-full border rounded-lg px-4 py-2">
                                    <option value="">اختر الصف</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">صف الأسبوع</label>
                                <select id="star-week-class" class="w-full border rounded-lg px-4 py-2">
                                    <option value="">اختر الصف</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">صف الشهر</label>
                                <select id="star-month-class" class="w-full border rounded-lg px-4 py-2">
                                    <option value="">اختر الصف</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="saveStarSelections()" class="bg-blue-500 text-white px-6 py-2 rounded-lg mt-6 hover:bg-blue-600">حفظ الاختيارات</button>
            </div>

            <!-- Certificates -->
            <div id="admin-certificates" class="admin-tab" style="display: none;">
                <h3 class="text-2xl font-bold mb-6">طباعة الشهادات</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button onclick="printCertificate('day-star')" class="bg-yellow-500 text-white px-4 py-3 rounded-lg hover:bg-yellow-600">شهادة نجمة اليوم</button>
                    <button onclick="printCertificate('week-star')" class="bg-orange-500 text-white px-4 py-3 rounded-lg hover:bg-orange-600">شهادة نجمة الأسبوع</button>
                    <button onclick="printCertificate('month-star')" class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600">شهادة نجمة الشهر</button>
                    <button onclick="printCertificate('queue-star')" class="bg-indigo-500 text-white px-4 py-3 rounded-lg hover:bg-indigo-600">شهادة نجم الطابور</button>
                    <button onclick="printCertificate('week-class')" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600">شهادة صف الأسبوع</button>
                    <button onclick="printCertificate('month-class')" class="bg-purple-500 text-white px-4 py-3 rounded-lg hover:bg-purple-600">شهادة صف الشهر</button>
                </div>
            </div>

            <!-- Settings -->
            <div id="admin-settings" class="admin-tab" style="display: none;">
                <h3 class="text-2xl font-bold mb-6">إعدادات النظام</h3>
                
                <div class="space-y-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">الشعارات</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">الشعار الأيسر</label>
                                <input type="file" id="left-logo-file" accept="image/*" class="border rounded-lg px-4 py-2 mb-2 w-full">
                                <button onclick="uploadLeftLogo()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 w-full">رفع الشعار الأيسر</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">الشعار الأيمن</label>
                                <input type="file" id="right-logo-file" accept="image/*" class="border rounded-lg px-4 py-2 mb-2 w-full">
                                <button onclick="uploadRightLogo()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 w-full">رفع الشعار الأيمن</button>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t">
                            <button onclick="clearLogos()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">مسح جميع الشعارات</button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">بيانات المدرسة</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="school-name" placeholder="اسم المدرسة" class="border rounded-lg px-4 py-2">
                            <input type="text" id="principal-name" placeholder="اسم المديرة" class="border rounded-lg px-4 py-2">
                        </div>
                        <button onclick="saveSchoolInfo()" class="bg-green-500 text-white px-6 py-2 rounded-lg mt-4 hover:bg-green-600">حفظ البيانات</button>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">كلمة مرور المدير</h4>
                        <input type="password" id="new-password" placeholder="كلمة المرور الجديدة" class="border rounded-lg px-4 py-2 mb-4">
                        <button onclick="changePassword()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">تغيير كلمة المرور</button>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div id="admin-data" class="admin-tab" style="display: none;">
                <h3 class="text-2xl font-bold mb-6">إدارة البيانات</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">التقارير</h4>
                        <div class="space-y-2">
                            <button onclick="exportDailyReport('pdf')" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">تصدير التقرير اليومي (PDF)</button>
                            <button onclick="exportDailyReport('image')" class="w-full bg-cyan-500 text-white px-4 py-2 rounded-lg hover:bg-cyan-600">تصدير التقرير اليومي (صورة)</button>
                            <button onclick="exportDailyReport('excel')" class="w-full bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600">تصدير التقرير اليومي (Excel)</button>
                            <button onclick="exportMonthlyReport('pdf')" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">تصدير التقرير الشهري (PDF)</button>
                            <button onclick="exportMonthlyReport('image')" class="w-full bg-lime-500 text-white px-4 py-2 rounded-lg hover:bg-lime-600">تصدير التقرير الشهري (صورة)</button>
                            <button onclick="exportMonthlyReport('excel')" class="w-full bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600">تصدير التقرير الشهري (Excel)</button>
                            <button onclick="exportToExcel()" class="w-full bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">تصدير جميع البيانات (Excel)</button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">النسخ الاحتياطي</h4>
                        <div class="space-y-2">
                            <button onclick="backupData()" class="w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">إنشاء نسخة احتياطية</button>
                            <input type="file" id="restore-file" accept=".json" class="w-full border rounded-lg px-4 py-2">
                            <button onclick="restoreData()" class="w-full bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600">استعادة النسخة الاحتياطية</button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-red-50 border border-red-200 p-6 rounded-lg mt-6">
                    <h4 class="text-lg font-semibold mb-4 text-red-800">منطقة الخطر</h4>
                    <div class="space-y-2">
                        <button onclick="clearAllData()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">مسح جميع البيانات</button>
                        <button onclick="resetSystem()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">إعادة تعيين النظام</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Camera Modal -->
    <div id="camera-modal" class="modal">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">تصوير الطابور</h3>
            <video id="camera-video" width="100%" height="300" autoplay class="border rounded-lg mb-4"></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            <div class="flex justify-between">
                <button onclick="capturePhoto()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">التقاط الصورة</button>
                <button onclick="closeCameraModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Certificate Modal -->
    <div id="certificate-modal" class="modal">
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full mx-4">
            <div id="certificate-content" class="certificate">
                <!-- Certificate content will be generated here -->
            </div>
            <div class="flex justify-center mt-6 space-x-4 space-x-reverse">
                <button onclick="downloadCertificate()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">تحميل الشهادة</button>
                <button onclick="closeCertificateModal()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">كلمة مرور المدير</h3>
            <input type="password" id="admin-password" placeholder="أدخل كلمة المرور" class="w-full border rounded-lg px-4 py-2 mb-4">
            <div class="flex justify-between">
                <button onclick="checkAdminPassword()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">دخول</button>
                <button onclick="closePasswordModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let teachers = [];
        let classes = [];
        let attendance = {};
        let classPoints = {};
        let settings = {
            adminPassword: '123456',
            schoolName: 'مدرسة النموذج الأساسية',
            principalName: 'أ. أحلام بنت علي الحمدانية',
            schoolLogo: null,
            leftLogo: null,
            rightLogo: null
        };
        let stars = {
            dayTeacher: null,
            weekTeacher: null,
            monthTeacher: null,
            queueClass: null,
            weekClass: null,
            monthClass: null
        };
        let currentTeacherForPhoto = null;
        let currentCertificateType = null;

        // Initialize System
        async function initSystem() {
            await loadData();
            checkNewDay();
            loadTeachers();
            loadClasses();
            updateStatistics();
            loadStarSelections();
        }

        // Data Management
        function saveData() {
            try {
                // Create comprehensive data object with timestamp
                const dataToSave = {
                    teachers: teachers,
                    classes: classes,
                    attendance: attendance,
                    classPoints: classPoints,
                    settings: settings,
                    stars: stars,
                    lastSaved: Date.now(),
                    version: '1.0'
                };
                
                // Save to localStorage with enhanced persistence
                localStorage.setItem('schoolQueue_data', JSON.stringify(dataToSave));
                localStorage.setItem('schoolQueue_teachers', JSON.stringify(teachers));
                localStorage.setItem('schoolQueue_classes', JSON.stringify(classes));
                localStorage.setItem('schoolQueue_attendance', JSON.stringify(attendance));
                localStorage.setItem('schoolQueue_classPoints', JSON.stringify(classPoints));
                localStorage.setItem('schoolQueue_settings', JSON.stringify(settings));
                localStorage.setItem('schoolQueue_stars', JSON.stringify(stars));
                localStorage.setItem('schoolQueue_lastDate', new Date().toDateString());
                
                // Enhanced sessionStorage backup
                sessionStorage.setItem('schoolQueue_data', JSON.stringify(dataToSave));
                sessionStorage.setItem('schoolQueue_teachers', JSON.stringify(teachers));
                sessionStorage.setItem('schoolQueue_classes', JSON.stringify(classes));
                sessionStorage.setItem('schoolQueue_attendance', JSON.stringify(attendance));
                sessionStorage.setItem('schoolQueue_classPoints', JSON.stringify(classPoints));
                sessionStorage.setItem('schoolQueue_settings', JSON.stringify(settings));
                sessionStorage.setItem('schoolQueue_stars', JSON.stringify(stars));
                
                // Enhanced browser cache with multiple keys for redundancy
                if ('caches' in window) {
                    caches.open('schoolQueue-v1').then(cache => {
                        const response = new Response(JSON.stringify(dataToSave));
                        cache.put('/schoolQueue-data', response);
                        cache.put('/schoolQueue-backup', response);
                        cache.put('/schoolQueue-persistent', response);
                    });
                }
                
                // Additional IndexedDB storage for maximum persistence
                if ('indexedDB' in window) {
                    const request = indexedDB.open('schoolQueueDB', 1);
                    request.onupgradeneeded = function(e) {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('data')) {
                            db.createObjectStore('data', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = function(e) {
                        const db = e.target.result;
                        const transaction = db.transaction(['data'], 'readwrite');
                        const store = transaction.objectStore('data');
                        store.put({ id: 'main', data: dataToSave });
                    };
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        async function loadData() {
            try {
                let dataLoaded = false;
                let loadedData = null;
                
                // Try IndexedDB first (most persistent)
                if ('indexedDB' in window) {
                    try {
                        const dbRequest = indexedDB.open('schoolQueueDB', 1);
                        const db = await new Promise((resolve, reject) => {
                            dbRequest.onsuccess = () => resolve(dbRequest.result);
                            dbRequest.onerror = () => reject(dbRequest.error);
                            dbRequest.onupgradeneeded = (e) => {
                                const db = e.target.result;
                                if (!db.objectStoreNames.contains('data')) {
                                    db.createObjectStore('data', { keyPath: 'id' });
                                }
                            };
                        });
                        
                        const transaction = db.transaction(['data'], 'readonly');
                        const store = transaction.objectStore('data');
                        const request = store.get('main');
                        
                        const result = await new Promise((resolve, reject) => {
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                        
                        if (result && result.data) {
                            loadedData = result.data;
                            dataLoaded = true;
                        }
                    } catch (e) {
                        console.log('IndexedDB not available or error:', e);
                    }
                }
                
                // Try comprehensive localStorage data
                if (!dataLoaded) {
                    const savedData = localStorage.getItem('schoolQueue_data');
                    if (savedData) {
                        try {
                            loadedData = JSON.parse(savedData);
                            dataLoaded = true;
                        } catch (e) {
                            console.log('Error parsing comprehensive localStorage data');
                        }
                    }
                }
                
                // Try cache storage
                if (!dataLoaded && 'caches' in window) {
                    try {
                        const cache = await caches.open('schoolQueue-v1');
                        const cacheKeys = ['/schoolQueue-data', '/schoolQueue-backup', '/schoolQueue-persistent'];
                        
                        for (const key of cacheKeys) {
                            const response = await cache.match(key);
                            if (response) {
                                const cachedData = await response.json();
                                if (cachedData && (cachedData.teachers || cachedData.data)) {
                                    loadedData = cachedData.data || cachedData;
                                    dataLoaded = true;
                                    break;
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Cache not available');
                    }
                }
                
                // Try individual localStorage items
                if (!dataLoaded) {
                    const savedTeachers = localStorage.getItem('schoolQueue_teachers');
                    const savedClasses = localStorage.getItem('schoolQueue_classes');
                    const savedAttendance = localStorage.getItem('schoolQueue_attendance');
                    const savedClassPoints = localStorage.getItem('schoolQueue_classPoints');
                    const savedSettings = localStorage.getItem('schoolQueue_settings');
                    const savedStars = localStorage.getItem('schoolQueue_stars');

                    if (savedTeachers) {
                        loadedData = {
                            teachers: JSON.parse(savedTeachers),
                            classes: savedClasses ? JSON.parse(savedClasses) : [],
                            attendance: savedAttendance ? JSON.parse(savedAttendance) : {},
                            classPoints: savedClassPoints ? JSON.parse(savedClassPoints) : {},
                            settings: savedSettings ? JSON.parse(savedSettings) : {},
                            stars: savedStars ? JSON.parse(savedStars) : {}
                        };
                        dataLoaded = true;
                    }
                }
                
                // Try sessionStorage as last resort
                if (!dataLoaded) {
                    const sessionData = sessionStorage.getItem('schoolQueue_data');
                    if (sessionData) {
                        try {
                            loadedData = JSON.parse(sessionData);
                            dataLoaded = true;
                        } catch (e) {
                            const sessionTeachers = sessionStorage.getItem('schoolQueue_teachers');
                            if (sessionTeachers) {
                                loadedData = {
                                    teachers: JSON.parse(sessionTeachers),
                                    classes: sessionStorage.getItem('schoolQueue_classes') ? JSON.parse(sessionStorage.getItem('schoolQueue_classes')) : [],
                                    attendance: sessionStorage.getItem('schoolQueue_attendance') ? JSON.parse(sessionStorage.getItem('schoolQueue_attendance')) : {},
                                    classPoints: sessionStorage.getItem('schoolQueue_classPoints') ? JSON.parse(sessionStorage.getItem('schoolQueue_classPoints')) : {},
                                    settings: sessionStorage.getItem('schoolQueue_settings') ? JSON.parse(sessionStorage.getItem('schoolQueue_settings')) : {},
                                    stars: sessionStorage.getItem('schoolQueue_stars') ? JSON.parse(sessionStorage.getItem('schoolQueue_stars')) : {}
                                };
                                dataLoaded = true;
                            }
                        }
                    }
                }

                // Apply loaded data
                if (dataLoaded && loadedData) {
                    teachers = loadedData.teachers || [];
                    classes = loadedData.classes || [];
                    attendance = loadedData.attendance || {};
                    classPoints = loadedData.classPoints || {};
                    settings = { ...settings, ...loadedData.settings };
                    stars = { ...stars, ...loadedData.stars };
                } else {
                    // Initialize with default data if nothing found
                    initializeDefaultData();
                }
                
                // Always save data after loading to ensure all storage methods are updated
                saveData();
                
            } catch (error) {
                console.error('Error loading data:', error);
                initializeDefaultData();
            }
        }

        function initializeDefaultData() {
            // Start with empty arrays - data will be added manually or via Excel
            teachers = [];
            classes = [];

            saveData();
        }

        function checkNewDay() {
            const lastDate = localStorage.getItem('schoolQueue_lastDate');
            const today = new Date().toDateString();
            
            if (lastDate !== today) {
                // Reset daily data
                teachers.forEach(teacher => {
                    attendance[teacher.id] = { status: 'pending', time: null };
                });
                stars.dayTeacher = null;
                saveData();
            }
        }

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.getElementById('attendance-section').style.display = 'none';
            document.getElementById('stars-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'none';

            // Show selected section
            if (section === 'admin') {
                showPasswordModal();
            } else {
                document.getElementById(section + '-section').style.display = 'block';
            }

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-opacity-75');
            });
        }

        // Admin Authentication
        function showPasswordModal() {
            document.getElementById('password-modal').classList.add('show');
        }

        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('show');
            document.getElementById('admin-password').value = '';
        }

        function checkAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === settings.adminPassword) {
                closePasswordModal();
                document.getElementById('admin-section').style.display = 'block';
                showAdminTab('teachers');
            } else {
                alert('كلمة المرور غير صحيحة');
            }
        }

        // Admin Tabs
        function showAdminTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.admin-tab').forEach(t => {
                t.style.display = 'none';
            });

            // Show selected tab
            document.getElementById('admin-' + tab).style.display = 'block';

            // Update tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('bg-opacity-75');
            });

            if (tab === 'stars-mgmt') {
                loadStarSelections();
            } else if (tab === 'teachers') {
                loadTeachersList();
            }
        }

        // Teachers Management
        function loadTeachers() {
            const grid = document.getElementById('teachers-grid');
            grid.innerHTML = '';

            teachers.forEach(teacher => {
                const card = createTeacherCard(teacher);
                grid.appendChild(card);
            });

            updateStatistics();
            loadDailySignatures();
        }

        function loadDailySignatures() {
            const signaturesGrid = document.getElementById('daily-signatures');
            const currentDateElement = document.getElementById('current-date');
            
            if (currentDateElement) {
                currentDateElement.textContent = new Date().toLocaleDateString('ar-SA');
            }
            
            if (signaturesGrid) {
                signaturesGrid.innerHTML = '';
                
                teachers.forEach(teacher => {
                    const status = attendance[teacher.id]?.status || 'pending';
                    const time = attendance[teacher.id]?.time || '';
                    
                    if (status === 'present' || status === 'late') {
                        const signatureCard = document.createElement('div');
                        signatureCard.className = 'bg-gray-50 border-2 border-dashed border-gray-300 p-4 rounded-lg text-center';
                        
                        let statusColor = 'text-green-600';
                        let statusIcon = '✓';
                        if (status === 'late') {
                            statusColor = 'text-yellow-600';
                            statusIcon = '⏰';
                        }
                        
                        signatureCard.innerHTML = `
                            <div class="font-bold text-lg mb-2">${teacher.name}</div>
                            <div class="text-sm text-gray-600 mb-2">${teacher.class}</div>
                            <div class="${statusColor} font-semibold mb-1">${statusIcon} ${getStatusText(status)}</div>
                            <div class="text-xs text-gray-500">${time}</div>
                            <div class="mt-3 pt-3 border-t border-gray-300">
                                <div class="text-xs text-gray-400">التوقيع</div>
                                <div class="h-8 border-b border-gray-400 mt-1"></div>
                            </div>
                        `;
                        
                        signaturesGrid.appendChild(signatureCard);
                    }
                });
                
                if (signaturesGrid.children.length === 0) {
                    signaturesGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">لا توجد معلمات حاضرات اليوم</div>';
                }
            }
        }

        function createTeacherCard(teacher) {
            const card = document.createElement('div');
            const status = attendance[teacher.id]?.status || 'pending';
            
            let cardClass = 'bg-white card-hover';
            if (status === 'present') cardClass = 'present-card';
            else if (status === 'absent') cardClass = 'absent-card';
            else if (status === 'late') cardClass = 'late-card';
            else if (status === 'excuse') cardClass = 'excuse-card';

            card.className = `${cardClass} p-6 rounded-lg shadow-md`;
            
            const photoSrc = teacher.photo || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iMzUiIHI9IjE1IiBmaWxsPSIjOUI5QkEzIi8+CjxwYXRoIGQ9Ik0yMCA4MEM0MCA2MCA2MCA2MCA4MCA4MEgyMFoiIGZpbGw9IiM5QjlCQTMiLz4KPC9zdmc+';

            card.innerHTML = `
                <div class="text-center">
                    <img src="${photoSrc}" alt="${teacher.name}" class="w-20 h-20 rounded-full mx-auto mb-4 object-cover">
                    <h3 class="text-lg font-semibold mb-2">${teacher.class}</h3>
                    <p class="text-sm opacity-75 mb-4">${teacher.name}</p>
                    
                    ${status === 'pending' ? `
                        <div class="space-y-2">
                            <button onclick="markAttendance(${teacher.id}, 'present')" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">تسجيل حضور</button>
                            <button onclick="markAttendance(${teacher.id}, 'absent')" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">تسجيل غياب</button>
                            <button onclick="markAttendance(${teacher.id}, 'late')" class="w-full bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600">متأخرة</button>
                            <button onclick="markAttendance(${teacher.id}, 'excuse')" class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600">عذر</button>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            <p class="text-sm">الحالة: ${getStatusText(status)}</p>
                            ${attendance[teacher.id]?.time ? `<p class="text-xs">الوقت: ${attendance[teacher.id].time}</p>` : ''}
                            <button onclick="resetAttendance(${teacher.id})" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">إعادة تعيين</button>
                        </div>
                    `}
                    
                    <button onclick="openCamera(${teacher.id})" class="w-full bg-blue-500 text-white py-2 rounded-lg mt-2 hover:bg-blue-600">📷 تصوير الطابور</button>
                </div>
            `;

            return card;
        }

        function getStatusText(status) {
            const statusMap = {
                'present': 'حاضرة',
                'absent': 'غائبة',
                'late': 'متأخرة',
                'excuse': 'عذر'
            };
            return statusMap[status] || 'غير محدد';
        }

        function markAttendance(teacherId, status) {
            const now = new Date();
            attendance[teacherId] = {
                status: status,
                time: now.toLocaleTimeString('ar-SA')
            };

            // Set star of the day for first present teacher
            if (status === 'present' && !stars.dayTeacher) {
                const teacher = teachers.find(t => t.id === teacherId);
                stars.dayTeacher = teacher.name;
                document.getElementById('star-of-day').textContent = teacher.name;
                document.getElementById('star-of-day-header').textContent = teacher.name;
            }

            saveData();
            loadTeachers();
        }

        function resetAttendance(teacherId) {
            attendance[teacherId] = { status: 'pending', time: null };
            
            // Reset star of the day if this was the star
            const teacher = teachers.find(t => t.id === teacherId);
            if (stars.dayTeacher === teacher.name) {
                stars.dayTeacher = null;
                document.getElementById('star-of-day').textContent = 'لم يتم اختيار نجمة اليوم بعد';
                document.getElementById('star-of-day-header').textContent = 'لم يتم اختيار نجمة اليوم بعد';
            }

            saveData();
            loadTeachers();
        }

        function updateStatistics() {
            let present = 0, absent = 0, pending = 0;
            
            teachers.forEach(teacher => {
                const status = attendance[teacher.id]?.status || 'pending';
                if (status === 'present' || status === 'late') present++;
                else if (status === 'absent') absent++;
                else pending++;
            });

            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('total-count').textContent = teachers.length;

            // Calculate class star based on teacher attendance
            let bestClass = null;
            let bestAttendanceRate = -1;
            
            // Group teachers by class and calculate attendance rate
            const classAttendance = {};
            teachers.forEach(teacher => {
                if (!classAttendance[teacher.class]) {
                    classAttendance[teacher.class] = { present: 0, total: 0 };
                }
                classAttendance[teacher.class].total++;
                const status = attendance[teacher.id]?.status || 'pending';
                if (status === 'present') {
                    classAttendance[teacher.class].present++;
                }
            });
            
            // Find class with best attendance rate
            Object.keys(classAttendance).forEach(className => {
                const rate = classAttendance[className].present / classAttendance[className].total;
                if (rate > bestAttendanceRate && classAttendance[className].present > 0) {
                    bestAttendanceRate = rate;
                    bestClass = className;
                }
            });

            // Update star displays
            document.getElementById('star-of-day').textContent = stars.dayTeacher || 'لم يتم اختيار نجمة اليوم بعد';
            document.getElementById('star-of-day-header').textContent = stars.dayTeacher || 'لم يتم اختيار نجمة اليوم بعد';
            
            // Find the class with highest total points for queue star (automatic)
            let topClass = null;
            let maxPoints = -1;
            
            classes.forEach(cls => {
                const points = classPoints[cls.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                const totalPoints = points.speed + points.quiet + points.cleanliness;
                if (totalPoints > maxPoints) {
                    maxPoints = totalPoints;
                    topClass = cls.name;
                }
            });
            
            // Auto-update queue star based on highest points
            if (topClass && maxPoints > 0) {
                stars.queueClass = `${topClass} (${maxPoints} نقطة)`;
                saveData(); // Save the auto-updated queue star
            }
            
            // Update queue star display
            const queueStarText = stars.queueClass || 'لم يتم اختيار نجم الطابور بعد';
            document.getElementById('star-of-queue').textContent = queueStarText;
            document.getElementById('star-of-queue-header').textContent = queueStarText;
            
            // Update monthly stars display
            document.getElementById('star-of-month-teacher').textContent = stars.monthTeacher || 'لم يتم الاختيار';
            document.getElementById('star-of-month-teacher-header').textContent = stars.monthTeacher || 'لم يتم الاختيار';
            document.getElementById('star-of-month-class').textContent = stars.monthClass || 'لم يتم الاختيار';
            document.getElementById('star-of-queue-month-header').textContent = stars.monthClass || 'لم يتم الاختيار';
        }

        // Classes Management
        function loadClasses() {
            const grid = document.getElementById('classes-grid');
            grid.innerHTML = '';

            // Only display classes if they exist
            classes.forEach(cls => {
                // Initialize class points if not exists
                if (!classPoints[cls.id]) {
                    classPoints[cls.id] = { speed: 0, quiet: 0, cleanliness: 0 };
                }
                
                const card = createClassCard(cls);
                grid.appendChild(card);
            });
        }

        function extractClassesFromTeachers() {
            // Get unique classes from teachers and auto-create class objects
            const uniqueClasses = [...new Set(teachers.map(teacher => teacher.class))];
            
            // Clear existing classes and rebuild from teachers data
            classes = [];
            
            uniqueClasses.forEach((className, index) => {
                const newId = index + 1;
                const cls = { id: newId, name: className };
                classes.push(cls);
                
                // Initialize class points if not exists
                if (!classPoints[cls.id]) {
                    classPoints[cls.id] = { speed: 0, quiet: 0, cleanliness: 0 };
                }
            });
            
            // Save updated classes
            saveData();
        }

        function createClassCard(cls) {
            const card = document.createElement('div');
            const points = classPoints[cls.id] || { speed: 0, quiet: 0, cleanliness: 0 };
            const totalPoints = points.speed + points.quiet + points.cleanliness;

            card.className = 'bg-white p-6 rounded-lg shadow-md card-hover';
            card.innerHTML = `
                <div class="text-center">
                    <h3 class="text-xl font-bold mb-2">${cls.name}</h3>
                    <div class="text-3xl font-bold text-blue-600 mb-4">${totalPoints} نقطة</div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm">سرعة الاصطفاف</span>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <button onclick="updateClassPoints(${cls.id}, 'speed', -1)" class="bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600">-</button>
                                <span class="w-8 text-center font-bold">${points.speed}</span>
                                <button onclick="updateClassPoints(${cls.id}, 'speed', 1)" class="bg-green-500 text-white w-8 h-8 rounded-full hover:bg-green-600">+</button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-sm">الهدوء والنظام</span>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <button onclick="updateClassPoints(${cls.id}, 'quiet', -1)" class="bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600">-</button>
                                <span class="w-8 text-center font-bold">${points.quiet}</span>
                                <button onclick="updateClassPoints(${cls.id}, 'quiet', 1)" class="bg-green-500 text-white w-8 h-8 rounded-full hover:bg-green-600">+</button>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-sm">النظافة الشخصية</span>
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <button onclick="updateClassPoints(${cls.id}, 'cleanliness', -1)" class="bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600">-</button>
                                <span class="w-8 text-center font-bold">${points.cleanliness}</span>
                                <button onclick="updateClassPoints(${cls.id}, 'cleanliness', 1)" class="bg-green-500 text-white w-8 h-8 rounded-full hover:bg-green-600">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        function updateClassPoints(classId, criterion, change) {
            if (!classPoints[classId]) {
                classPoints[classId] = { speed: 0, quiet: 0, cleanliness: 0 };
            }
            
            classPoints[classId][criterion] = Math.max(0, classPoints[classId][criterion] + change);
            saveData();
            loadClasses();
            
            // Auto-update queue star when points change
            updateStatistics();
        }

        // Camera Functions
        function openCamera(teacherId) {
            currentTeacherForPhoto = teacherId;
            document.getElementById('camera-modal').classList.add('show');
            
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    document.getElementById('camera-video').srcObject = stream;
                })
                .catch(err => {
                    alert('لا يمكن الوصول إلى الكاميرا');
                    closeCameraModal();
                });
        }

        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const photoData = canvas.toDataURL('image/jpeg');
            
            // Save photo to teacher
            const teacher = teachers.find(t => t.id === currentTeacherForPhoto);
            if (teacher) {
                teacher.photo = photoData;
                saveData();
                loadTeachers();
            }
            
            closeCameraModal();
        }

        function closeCameraModal() {
            const video = document.getElementById('camera-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('camera-modal').classList.remove('show');
            currentTeacherForPhoto = null;
        }

        // Admin Functions
        function addTeacher() {
            const name = document.getElementById('teacher-name').value.trim();
            const className = document.getElementById('teacher-class').value.trim();
            
            if (!name || !className) {
                alert('يرجى إدخال جميع البيانات');
                return;
            }
            
            const newId = Math.max(...teachers.map(t => t.id), 0) + 1;
            const newTeacher = {
                id: newId,
                name: name,
                class: className,
                photo: null
            };
            
            teachers.push(newTeacher);
            attendance[newId] = { status: 'pending', time: null };
            
            // Extract classes from updated teachers data
            extractClassesFromTeachers();
            
            saveData();
            loadTeachers();
            loadClasses();
            loadTeachersList();
            
            document.getElementById('teacher-name').value = '';
            document.getElementById('teacher-class').value = '';
            
            alert('تم إضافة المعلمة بنجاح');
        }

        function uploadExcel() {
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('يرجى اختيار ملف Excel');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Clear existing data when uploading new Excel file
                    teachers = [];
                    classes = [];
                    attendance = {};
                    classPoints = {};
                    
                    let addedCount = 0;
                    
                    // Try to read from first sheet
                    if (workbook.SheetNames.length > 0) {
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Skip header row and process data
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 2) {
                                const name = row[0] ? String(row[0]).trim() : '';
                                const className = row[1] ? String(row[1]).trim() : '';
                                
                                if (name && className) {
                                    const newId = addedCount + 1;
                                    teachers.push({
                                        id: newId,
                                        name: name,
                                        class: className,
                                        photo: null
                                    });
                                    attendance[newId] = { status: 'pending', time: null };
                                    addedCount++;
                                }
                            }
                        }
                    }
                    
                    // Extract classes from teachers data after loading all teachers
                    extractClassesFromTeachers();
                    
                    // Force save to localStorage
                    localStorage.setItem('schoolQueue_teachers', JSON.stringify(teachers));
                    localStorage.setItem('schoolQueue_classes', JSON.stringify(classes));
                    localStorage.setItem('schoolQueue_attendance', JSON.stringify(attendance));
                    localStorage.setItem('schoolQueue_classPoints', JSON.stringify(classPoints));
                    
                    loadTeachers();
                    loadClasses();
                    loadTeachersList();
                    loadStarSelections();
                    
                    // Show attendance section automatically after import
                    showSection('attendance');
                    
                    alert(`تم استبدال البيانات وإضافة ${addedCount} معلمة بنجاح`);
                    fileInput.value = '';
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    alert('خطأ في قراءة الملف. تأكد من أن الملف يحتوي على عمودين: اسم المعلمة والصف');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function uploadClassesExcel() {
            const fileInput = document.getElementById('classes-excel-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('يرجى اختيار ملف Excel للصفوف');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Clear existing classes
                    classes = [];
                    classPoints = {};
                    
                    let addedCount = 0;
                    
                    // Try to read from first sheet
                    if (workbook.SheetNames.length > 0) {
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Skip header row and process data
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.length >= 1) {
                                const className = row[0] ? String(row[0]).trim() : '';
                                
                                if (className) {
                                    const newId = addedCount + 1;
                                    classes.push({
                                        id: newId,
                                        name: className
                                    });
                                    
                                    // Initialize class points
                                    classPoints[newId] = { speed: 0, quiet: 0, cleanliness: 0 };
                                    addedCount++;
                                }
                            }
                        }
                    }
                    
                    // Force save to localStorage
                    localStorage.setItem('schoolQueue_classes', JSON.stringify(classes));
                    localStorage.setItem('schoolQueue_classPoints', JSON.stringify(classPoints));
                    
                    loadClasses();
                    loadStarSelections();
                    
                    alert(`تم إضافة ${addedCount} صف بنجاح`);
                    fileInput.value = '';
                    
                    // Show stars section automatically after import
                    showSection('stars');
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    alert('خطأ في قراءة الملف. تأكد من أن الملف يحتوي على عمود واحد بأسماء الصفوف');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadTeachersList() {
            const list = document.getElementById('teachers-list');
            list.innerHTML = '';
            
            teachers.forEach(teacher => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-white p-3 rounded border';
                item.innerHTML = `
                    <div>
                        <span class="font-semibold">${teacher.class}</span>
                        <span class="text-gray-600 text-sm mr-2">(${teacher.name})</span>
                    </div>
                    <button onclick="removeTeacher(${teacher.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">حذف</button>
                `;
                list.appendChild(item);
            });
        }

        function removeTeacher(teacherId) {
            if (confirm('هل أنت متأكد من حذف هذه المعلمة؟')) {
                teachers = teachers.filter(t => t.id !== teacherId);
                delete attendance[teacherId];
                
                saveData();
                loadTeachers();
                loadTeachersList();
            }
        }

        function loadStarSelections() {
            // Load teachers into dropdowns - only show teachers who are present or late
            const teacherSelects = ['star-week-teacher', 'star-month-teacher'];
            teacherSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">اختر المعلمة</option>';
                
                // Filter teachers based on attendance status
                const presentTeachers = teachers.filter(teacher => {
                    const status = attendance[teacher.id]?.status || 'pending';
                    return status === 'present' || status === 'late';
                });
                
                presentTeachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.name;
                    const status = attendance[teacher.id]?.status;
                    const statusText = status === 'late' ? ' (متأخرة)' : ' (حاضرة)';
                    option.textContent = teacher.name + statusText;
                    select.appendChild(option);
                });
            });
            
            // Load classes into dropdowns - calculate attendance rate for each class
            const classSelects = ['star-week-class', 'star-month-class'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">اختر الصف</option>';
                
                // Calculate attendance rate for each class
                const classAttendanceRates = {};
                classes.forEach(cls => {
                    const classTeachers = teachers.filter(teacher => teacher.class === cls.name);
                    if (classTeachers.length > 0) {
                        const presentCount = classTeachers.filter(teacher => {
                            const status = attendance[teacher.id]?.status || 'pending';
                            return status === 'present' || status === 'late';
                        }).length;
                        
                        const attendanceRate = Math.round((presentCount / classTeachers.length) * 100);
                        classAttendanceRates[cls.name] = {
                            rate: attendanceRate,
                            present: presentCount,
                            total: classTeachers.length
                        };
                    }
                });
                
                // Sort classes by attendance rate (highest first)
                const sortedClasses = classes.sort((a, b) => {
                    const rateA = classAttendanceRates[a.name]?.rate || 0;
                    const rateB = classAttendanceRates[b.name]?.rate || 0;
                    return rateB - rateA;
                });
                
                sortedClasses.forEach(cls => {
                    const attendanceInfo = classAttendanceRates[cls.name];
                    if (attendanceInfo) {
                        const option = document.createElement('option');
                        option.value = cls.name;
                        option.textContent = `${cls.name} (${attendanceInfo.rate}% - ${attendanceInfo.present}/${attendanceInfo.total})`;
                        select.appendChild(option);
                    }
                });
            });
            
            // Load queue class dropdown - show classes with their total points
            const queueSelect = document.getElementById('star-queue-class');
            queueSelect.innerHTML = '<option value="">اختر الصف</option>';
            
            // Sort classes by total points (highest first)
            const sortedClassesByPoints = classes.sort((a, b) => {
                const pointsA = classPoints[a.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                const pointsB = classPoints[b.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                const totalA = pointsA.speed + pointsA.quiet + pointsA.cleanliness;
                const totalB = pointsB.speed + pointsB.quiet + pointsB.cleanliness;
                return totalB - totalA;
            });
            
            sortedClassesByPoints.forEach(cls => {
                const points = classPoints[cls.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                const totalPoints = points.speed + points.quiet + points.cleanliness;
                const option = document.createElement('option');
                option.value = cls.name;
                option.textContent = `${cls.name} (${totalPoints} نقطة)`;
                queueSelect.appendChild(option);
            });
            
            // Set current values
            document.getElementById('star-week-teacher').value = stars.weekTeacher || '';
            document.getElementById('star-month-teacher').value = stars.monthTeacher || '';
            document.getElementById('star-queue-class').value = stars.queueClass || '';
            document.getElementById('star-week-class').value = stars.weekClass || '';
            document.getElementById('star-month-class').value = stars.monthClass || '';
        }

        function saveStarSelections() {
            stars.weekTeacher = document.getElementById('star-week-teacher').value;
            stars.monthTeacher = document.getElementById('star-month-teacher').value;
            stars.queueClass = document.getElementById('star-queue-class').value;
            stars.weekClass = document.getElementById('star-week-class').value;
            stars.monthClass = document.getElementById('star-month-class').value;
            
            // Update display
            document.getElementById('star-of-queue').textContent = stars.queueClass || 'لم يتم اختيار نجم الطابور بعد';
            document.getElementById('star-of-queue-header').textContent = stars.queueClass || 'لم يتم اختيار نجم الطابور بعد';
            document.getElementById('star-of-month-teacher-header').textContent = stars.monthTeacher || 'لم يتم الاختيار';
            
            // Force save to localStorage
            localStorage.setItem('schoolQueue_stars', JSON.stringify(stars));
            localStorage.setItem('schoolQueue_teachers', JSON.stringify(teachers));
            localStorage.setItem('schoolQueue_classes', JSON.stringify(classes));
            localStorage.setItem('schoolQueue_attendance', JSON.stringify(attendance));
            localStorage.setItem('schoolQueue_classPoints', JSON.stringify(classPoints));
            localStorage.setItem('schoolQueue_settings', JSON.stringify(settings));
            
            alert('تم حفظ اختيارات النجوم بنجاح');
        }

        // Certificate Functions
        function printCertificate(type) {
            currentCertificateType = type;
            let title, recipient, description;
            
            switch (type) {
                case 'day-star':
                    title = 'شهادة تقدير - نجمة اليوم';
                    recipient = stars.dayTeacher || 'لم يتم الاختيار';
                    description = 'لتميزها في الحضور المبكر والانضباط';
                    break;
                case 'week-star':
                    title = 'شهادة تقدير - نجمة الأسبوع';
                    recipient = stars.weekTeacher || 'لم يتم الاختيار';
                    description = 'لتميزها المستمر والتزامها الرائع';
                    break;
                case 'month-star':
                    title = 'شهادة تقدير - نجمة الشهر';
                    recipient = stars.monthTeacher || 'لم يتم الاختيار';
                    description = 'لأدائها المتميز طوال الشهر';
                    break;
                case 'queue-star':
                    title = 'شهادة تقدير - نجم الطابور';
                    recipient = stars.queueClass || 'لم يتم الاختيار';
                    description = 'للتميز في تنظيم الطابور والانضباط';
                    break;
                case 'week-class':
                    title = 'شهادة تقدير - صف الأسبوع';
                    recipient = stars.weekClass || 'لم يتم الاختيار';
                    description = 'للانضباط والنظام المتميز';
                    break;
                case 'month-class':
                    title = 'شهادة تقدير - صف الشهر';
                    recipient = stars.monthClass || 'لم يتم الاختيار';
                    description = 'للتفوق والانضباط المستمر';
                    break;
            }
            
            if (recipient === 'لم يتم الاختيار') {
                alert('يرجى اختيار المستلم أولاً من قسم إدارة النجوم');
                return;
            }
            
            const certificateContent = `
                <div class="text-center relative z-10">
                    <div class="text-4xl mb-4">🏆</div>
                    <h1 class="text-3xl font-bold text-amber-800 mb-6">${title}</h1>
                    <div class="text-lg mb-4">تُمنح هذه الشهادة إلى</div>
                    <div class="text-4xl font-bold text-amber-900 mb-6 border-b-2 border-amber-600 pb-2">${recipient}</div>
                    <div class="text-lg mb-8">${description}</div>
                    <div class="flex justify-between items-end">
                        <div class="text-right">
                            <div class="text-sm text-gray-600">التاريخ</div>
                            <div class="font-semibold">${new Date().toLocaleDateString('ar-SA')}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-2">🏫</div>
                            <div class="font-bold">${settings.schoolName}</div>
                        </div>
                        <div class="text-left">
                            <div class="text-sm text-gray-600">المديرة</div>
                            <div class="font-semibold">${settings.principalName}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('certificate-content').innerHTML = certificateContent;
            document.getElementById('certificate-modal').classList.add('show');
        }

        function downloadCertificate() {
            const certificateElement = document.getElementById('certificate-content');
            
            html2canvas(certificateElement, {
                backgroundColor: '#fef3c7',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `شهادة_${currentCertificateType}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function closeCertificateModal() {
            document.getElementById('certificate-modal').classList.remove('show');
        }

        // Settings Functions
        function uploadLeftLogo() {
            const fileInput = document.getElementById('left-logo-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('يرجى اختيار ملف الشعار الأيسر');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                settings.leftLogo = e.target.result;
                saveData();
                updateLogosDisplay();
                alert('تم رفع الشعار الأيسر بنجاح');
            };
            reader.readAsDataURL(file);
        }

        function uploadRightLogo() {
            const fileInput = document.getElementById('right-logo-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('يرجى اختيار ملف الشعار الأيمن');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                settings.rightLogo = e.target.result;
                saveData();
                updateLogosDisplay();
                alert('تم رفع الشعار الأيمن بنجاح');
            };
            reader.readAsDataURL(file);
        }

        function clearLogos() {
            if (confirm('هل أنت متأكد من حذف جميع الشعارات؟')) {
                settings.leftLogo = null;
                settings.rightLogo = null;
                saveData();
                updateLogosDisplay();
                alert('تم حذف جميع الشعارات بنجاح');
            }
        }

        function updateLogosDisplay() {
            // Update left logo (desktop)
            const leftLogo = document.getElementById('left-logo');
            const leftPlaceholder = document.getElementById('left-logo-placeholder');
            
            if (leftLogo && leftPlaceholder) {
                if (settings.leftLogo) {
                    leftLogo.src = settings.leftLogo;
                    leftLogo.style.display = 'block';
                    leftPlaceholder.style.display = 'none';
                } else {
                    leftLogo.style.display = 'none';
                    leftPlaceholder.style.display = 'block';
                }
            }
            
            // Update left logo (mobile)
            const leftLogoMobile = document.getElementById('left-logo-mobile');
            const leftPlaceholderMobile = document.getElementById('left-logo-placeholder-mobile');
            
            if (leftLogoMobile && leftPlaceholderMobile) {
                if (settings.leftLogo) {
                    leftLogoMobile.src = settings.leftLogo;
                    leftLogoMobile.style.display = 'block';
                    leftPlaceholderMobile.style.display = 'none';
                } else {
                    leftLogoMobile.style.display = 'none';
                    leftPlaceholderMobile.style.display = 'block';
                }
            }
            
            // Update right logo (desktop)
            const rightLogo = document.getElementById('right-logo');
            const rightPlaceholder = document.getElementById('right-logo-placeholder');
            
            if (rightLogo && rightPlaceholder) {
                if (settings.rightLogo) {
                    rightLogo.src = settings.rightLogo;
                    rightLogo.style.display = 'block';
                    rightPlaceholder.style.display = 'none';
                } else {
                    rightLogo.style.display = 'none';
                    rightPlaceholder.style.display = 'block';
                }
            }
            
            // Update right logo (mobile)
            const rightLogoMobile = document.getElementById('right-logo-mobile');
            const rightPlaceholderMobile = document.getElementById('right-logo-placeholder-mobile');
            
            if (rightLogoMobile && rightPlaceholderMobile) {
                if (settings.rightLogo) {
                    rightLogoMobile.src = settings.rightLogo;
                    rightLogoMobile.style.display = 'block';
                    rightPlaceholderMobile.style.display = 'none';
                } else {
                    rightLogoMobile.style.display = 'none';
                    rightPlaceholderMobile.style.display = 'block';
                }
            }
        }

        function saveSchoolInfo() {
            const schoolName = document.getElementById('school-name').value.trim();
            const principalName = document.getElementById('principal-name').value.trim();
            
            if (schoolName) settings.schoolName = schoolName;
            if (principalName) {
                settings.principalName = principalName;
                // Update display immediately
                document.getElementById('principal-display').textContent = principalName;
            }
            
            saveData();
            alert('تم حفظ بيانات المدرسة بنجاح');
        }

        function changePassword() {
            const newPassword = document.getElementById('new-password').value.trim();
            
            if (!newPassword) {
                alert('يرجى إدخال كلمة المرور الجديدة');
                return;
            }
            
            if (newPassword.length < 3) {
                alert('كلمة المرور يجب أن تكون 3 أحرف على الأقل');
                return;
            }
            
            settings.adminPassword = newPassword;
            saveData();
            alert('تم تغيير كلمة المرور بنجاح');
            document.getElementById('new-password').value = '';
        }

        // Data Export Functions
        function exportDailyReport(format = 'pdf') {
            const reportElement = document.createElement('div');
            reportElement.className = 'p-8 bg-white';
            reportElement.style.width = '800px';
            reportElement.innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold mb-2">${settings.schoolName}</h1>
                    <h2 class="text-2xl mb-4">التقرير اليومي للطابور المدرسي</h2>
                    <p class="text-lg">التاريخ: ${new Date().toLocaleDateString('ar-SA')}</p>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">إحصائيات الحضور</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-100 p-4 rounded">
                            <div class="text-2xl font-bold text-green-800">${document.getElementById('present-count').textContent}</div>
                            <div>الحاضرات</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded">
                            <div class="text-2xl font-bold text-red-800">${document.getElementById('absent-count').textContent}</div>
                            <div>الغائبات</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">نجمة اليوم</h3>
                    <div class="bg-yellow-100 p-4 rounded text-center">
                        <div class="text-2xl font-bold text-yellow-800">${stars.dayTeacher || 'لم يتم الاختيار'}</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-4">تفاصيل الحضور</h3>
                    <div class="table-container">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 p-2">اسم المعلمة</th>
                                    <th class="border border-gray-300 p-2">الصف</th>
                                    <th class="border border-gray-300 p-2">الحالة</th>
                                    <th class="border border-gray-300 p-2">الوقت</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${teachers.map(teacher => {
                                    const status = attendance[teacher.id]?.status || 'pending';
                                    const time = attendance[teacher.id]?.time || '-';
                                    return `
                                        <tr>
                                            <td class="border border-gray-300 p-2">${teacher.name}</td>
                                            <td class="border border-gray-300 p-2">${teacher.class}</td>
                                            <td class="border border-gray-300 p-2">${getStatusText(status)}</td>
                                            <td class="border border-gray-300 p-2">${time}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reportElement);
            
            if (format === 'excel') {
                // Export as Excel
                const wb = XLSX.utils.book_new();
                
                const dailyData = teachers.map(teacher => {
                    const status = attendance[teacher.id]?.status || 'pending';
                    const time = attendance[teacher.id]?.time || '';
                    return {
                        'اسم المعلمة': teacher.name,
                        'الصف': teacher.class,
                        'الحالة': getStatusText(status),
                        'وقت الحضور': time
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(dailyData);
                XLSX.utils.book_append_sheet(wb, ws, 'التقرير اليومي');
                
                XLSX.writeFile(wb, `التقرير_اليومي_${new Date().toISOString().split('T')[0]}.xlsx`);
                document.body.removeChild(reportElement);
                return;
            }
            
            html2canvas(reportElement, {
                backgroundColor: '#ffffff',
                scale: 2
            }).then(canvas => {
                if (format === 'image') {
                    // Export as image
                    const link = document.createElement('a');
                    link.download = `التقرير_اليومي_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else {
                    // Export as PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`التقرير_اليومي_${new Date().toISOString().split('T')[0]}.pdf`);
                }
                document.body.removeChild(reportElement);
            });
        }

        function exportMonthlyReport(format = 'pdf') {
            const reportElement = document.createElement('div');
            reportElement.className = 'p-8 bg-white';
            reportElement.style.width = '800px';
            
            // Calculate monthly statistics
            const currentMonth = new Date().toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' });
            
            reportElement.innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold mb-2">${settings.schoolName}</h1>
                    <h2 class="text-2xl mb-4">التقرير الشهري للطابور المدرسي</h2>
                    <p class="text-lg">الشهر: ${currentMonth}</p>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">نجوم الشهر</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-yellow-100 p-4 rounded">
                            <div class="text-lg font-bold text-yellow-800">نجمة الشهر</div>
                            <div class="text-xl">${stars.monthTeacher || 'لم يتم الاختيار'}</div>
                        </div>
                        <div class="bg-blue-100 p-4 rounded">
                            <div class="text-lg font-bold text-blue-800">صف الشهر</div>
                            <div class="text-xl">${stars.monthClass || 'لم يتم الاختيار'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">نجوم الأسبوع</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-orange-100 p-4 rounded">
                            <div class="text-lg font-bold text-orange-800">نجمة الأسبوع</div>
                            <div class="text-xl">${stars.weekTeacher || 'لم يتم الاختيار'}</div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded">
                            <div class="text-lg font-bold text-purple-800">صف الأسبوع</div>
                            <div class="text-xl">${stars.weekClass || 'لم يتم الاختيار'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">نجم الطابور</h3>
                    <div class="bg-indigo-100 p-4 rounded text-center">
                        <div class="text-2xl font-bold text-indigo-800">${stars.queueClass || 'لم يتم الاختيار'}</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-4">نقاط الصفوف</h3>
                    <div class="table-container">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 p-2">الصف</th>
                                    <th class="border border-gray-300 p-2">سرعة الاصطفاف</th>
                                    <th class="border border-gray-300 p-2">الهدوء والنظام</th>
                                    <th class="border border-gray-300 p-2">النظافة الشخصية</th>
                                    <th class="border border-gray-300 p-2">المجموع</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${classes.map(cls => {
                                    const points = classPoints[cls.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                                    const total = points.speed + points.quiet + points.cleanliness;
                                    return `
                                        <tr>
                                            <td class="border border-gray-300 p-2">${cls.name}</td>
                                            <td class="border border-gray-300 p-2 text-center">${points.speed}</td>
                                            <td class="border border-gray-300 p-2 text-center">${points.quiet}</td>
                                            <td class="border border-gray-300 p-2 text-center">${points.cleanliness}</td>
                                            <td class="border border-gray-300 p-2 text-center font-bold">${total}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.body.appendChild(reportElement);
            
            if (format === 'excel') {
                // Export as Excel
                const wb = XLSX.utils.book_new();
                
                // Stars data
                const starsData = [
                    { 'النوع': 'نجمة اليوم', 'الاسم': stars.dayTeacher || 'لم يتم الاختيار' },
                    { 'النوع': 'نجمة الأسبوع', 'الاسم': stars.weekTeacher || 'لم يتم الاختيار' },
                    { 'النوع': 'نجمة الشهر', 'الاسم': stars.monthTeacher || 'لم يتم الاختيار' },
                    { 'النوع': 'نجم الطابور', 'الاسم': stars.queueClass || 'لم يتم الاختيار' },
                    { 'النوع': 'صف الأسبوع', 'الاسم': stars.weekClass || 'لم يتم الاختيار' },
                    { 'النوع': 'صف الشهر', 'الاسم': stars.monthClass || 'لم يتم الاختيار' }
                ];
                
                const starsWs = XLSX.utils.json_to_sheet(starsData);
                XLSX.utils.book_append_sheet(wb, starsWs, 'النجوم');
                
                // Class points data
                const classData = classes.map(cls => {
                    const points = classPoints[cls.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                    const total = points.speed + points.quiet + points.cleanliness;
                    return {
                        'الصف': cls.name,
                        'سرعة الاصطفاف': points.speed,
                        'الهدوء والنظام': points.quiet,
                        'النظافة الشخصية': points.cleanliness,
                        'المجموع': total
                    };
                });
                
                const classWs = XLSX.utils.json_to_sheet(classData);
                XLSX.utils.book_append_sheet(wb, classWs, 'نقاط الصفوف');
                
                XLSX.writeFile(wb, `التقرير_الشهري_${new Date().toISOString().split('T')[0]}.xlsx`);
                document.body.removeChild(reportElement);
                return;
            }
            
            html2canvas(reportElement, {
                backgroundColor: '#ffffff',
                scale: 2
            }).then(canvas => {
                if (format === 'image') {
                    // Export as image
                    const link = document.createElement('a');
                    link.download = `التقرير_الشهري_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } else {
                    // Export as PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`التقرير_الشهري_${new Date().toISOString().split('T')[0]}.pdf`);
                }
                document.body.removeChild(reportElement);
            });
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Daily attendance sheet
            const dailyData = teachers.map(teacher => {
                const status = attendance[teacher.id]?.status || 'pending';
                const time = attendance[teacher.id]?.time || '';
                return {
                    'اسم المعلمة': teacher.name,
                    'الصف': teacher.class,
                    'الحالة': getStatusText(status),
                    'وقت الحضور': time
                };
            });
            
            const dailyWs = XLSX.utils.json_to_sheet(dailyData);
            XLSX.utils.book_append_sheet(wb, dailyWs, 'الحضور اليومي');
            
            // Class points sheet
            const classData = classes.map(cls => {
                const points = classPoints[cls.id] || { speed: 0, quiet: 0, cleanliness: 0 };
                const total = points.speed + points.quiet + points.cleanliness;
                return {
                    'الصف': cls.name,
                    'سرعة الاصطفاف': points.speed,
                    'الهدوء والنظام': points.quiet,
                    'النظافة الشخصية': points.cleanliness,
                    'المجموع': total
                };
            });
            
            const classWs = XLSX.utils.json_to_sheet(classData);
            XLSX.utils.book_append_sheet(wb, classWs, 'نقاط الصفوف');
            
            // Stars sheet
            const starsData = [
                { 'النوع': 'نجمة اليوم', 'الاسم': stars.dayTeacher || 'لم يتم الاختيار' },
                { 'النوع': 'نجمة الأسبوع', 'الاسم': stars.weekTeacher || 'لم يتم الاختيار' },
                { 'النوع': 'نجمة الشهر', 'الاسم': stars.monthTeacher || 'لم يتم الاختيار' },
                { 'النوع': 'نجم الطابور', 'الاسم': stars.queueClass || 'لم يتم الاختيار' },
                { 'النوع': 'صف الأسبوع', 'الاسم': stars.weekClass || 'لم يتم الاختيار' },
                { 'النوع': 'صف الشهر', 'الاسم': stars.monthClass || 'لم يتم الاختيار' }
            ];
            
            const starsWs = XLSX.utils.json_to_sheet(starsData);
            XLSX.utils.book_append_sheet(wb, starsWs, 'النجوم');
            
            XLSX.writeFile(wb, `تقرير_الطابور_المدرسي_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function backupData() {
            const backup = {
                teachers,
                classes,
                attendance,
                classPoints,
                settings,
                stars,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `نسخة_احتياطية_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function restoreData() {
            const fileInput = document.getElementById('restore-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('يرجى اختيار ملف النسخة الاحتياطية');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (confirm('هل أنت متأكد من استعادة النسخة الاحتياطية؟ سيتم حذف جميع البيانات الحالية.')) {
                        teachers = backup.teachers || [];
                        classes = backup.classes || [];
                        attendance = backup.attendance || {};
                        classPoints = backup.classPoints || {};
                        settings = { ...settings, ...backup.settings };
                        stars = { ...stars, ...backup.stars };
                        
                        saveData();
                        location.reload();
                    }
                } catch (error) {
                    alert('خطأ في قراءة ملف النسخة الاحتياطية');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                if (confirm('تأكيد أخير: سيتم حذف جميع البيانات نهائياً!')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        function resetSystem() {
            if (confirm('هل أنت متأكد من إعادة تعيين النظام؟ سيتم الاحتفاظ بالمعلمات والصفوف فقط.')) {
                // Reset attendance and points but keep teachers and classes
                teachers.forEach(teacher => {
                    attendance[teacher.id] = { status: 'pending', time: null };
                });
                
                classes.forEach(cls => {
                    classPoints[cls.id] = { speed: 0, quiet: 0, cleanliness: 0 };
                });
                
                stars = {
                    dayTeacher: null,
                    weekTeacher: null,
                    monthTeacher: null,
                    queueClass: null,
                    weekClass: null,
                    monthClass: null
                };
                
                saveData();
                location.reload();
            }
        }

        // Enhanced Mouse Trail Effect
        let mouseTrails = [];
        let colorZone = null;
        
        document.addEventListener('mousemove', function(e) {
            // Create enhanced trail element
            const trail = document.createElement('div');
            trail.className = 'mouse-trail';
            trail.style.left = (e.clientX - 12) + 'px';
            trail.style.top = (e.clientY - 12) + 'px';
            
            document.body.appendChild(trail);
            mouseTrails.push(trail);
            
            // Create color change zone
            if (!colorZone) {
                colorZone = document.createElement('div');
                colorZone.className = 'color-change-zone';
                document.body.appendChild(colorZone);
            }
            
            colorZone.style.left = (e.clientX - 50) + 'px';
            colorZone.style.top = (e.clientY - 50) + 'px';
            
            // Remove trail after animation
            setTimeout(() => {
                if (trail.parentNode) {
                    trail.parentNode.removeChild(trail);
                }
                mouseTrails = mouseTrails.filter(t => t !== trail);
            }, 1200);
            
            // Limit number of trails
            if (mouseTrails.length > 8) {
                const oldTrail = mouseTrails.shift();
                if (oldTrail.parentNode) {
                    oldTrail.parentNode.removeChild(oldTrail);
                }
            }
        });

        // Enhanced Click Ripple Effect
        document.addEventListener('click', function(e) {
            // Create multiple ripple elements for enhanced effect
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ripple = document.createElement('div');
                    ripple.className = 'click-ripple';
                    ripple.style.left = (e.clientX - 200) + 'px';
                    ripple.style.top = (e.clientY - 200) + 'px';
                    
                    document.body.appendChild(ripple);
                    
                    // Remove ripple after animation
                    setTimeout(() => {
                        if (ripple.parentNode) {
                            ripple.parentNode.removeChild(ripple);
                        }
                    }, 1200);
                }, i * 100);
            }
        });

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            
            const dateTimeString = now.toLocaleDateString('ar-SA', options);
            
            const dateTimeElement = document.getElementById('current-datetime');
            if (dateTimeElement) {
                dateTimeElement.textContent = dateTimeString;
            }
        }

        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await initSystem();
            updateLogosDisplay();
            updatePrincipalDisplay();
            
            // Start updating time immediately and every second
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Auto-save data every 30 seconds
            setInterval(function() {
                saveData();
            }, 30000);
            
            // Save data when page is about to unload
            window.addEventListener('beforeunload', function() {
                saveData();
            });
            
            // Save data when page becomes hidden (mobile/tab switching)
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveData();
                }
            });
            
            // Save data on any user interaction
            document.addEventListener('click', function() {
                setTimeout(saveData, 100);
            });
            
            document.addEventListener('input', function() {
                setTimeout(saveData, 500);
            });
            
            // Set default values for settings inputs
            document.getElementById('school-name').value = settings.schoolName;
            document.getElementById('principal-name').value = settings.principalName;
        });
        
        // Update principal display
        function updatePrincipalDisplay() {
            const principalDisplay = document.getElementById('principal-display');
            if (principalDisplay && settings.principalName) {
                principalDisplay.textContent = settings.principalName;
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e9124b1399127c',t:'MTc1Nzc4MTQ3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
