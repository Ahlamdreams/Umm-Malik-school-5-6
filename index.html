<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الطابور المدرسي - نظام إدارة متكامل</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Noto Sans Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            font-family: 'Noto Sans Arabic', sans-serif;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: all 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .card-modern:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 35px 70px -12px rgba(0, 0, 0, 0.35);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .btn-gradient:hover::before {
            left: 100%;
        }
        
        .btn-gradient:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }
        
        .floating-animation {
            animation: floating 4s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(2deg); }
        }
        
        .pulse-glow {
            animation: pulse-glow 3s infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(102, 126, 234, 0.6);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 60px rgba(102, 126, 234, 0.9);
                transform: scale(1.08);
            }
        }
        
        .student-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6, #ef4444);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .student-card:hover::before {
            transform: scaleX(1);
        }
        
        .student-card:hover {
            transform: translateY(-10px) rotateY(5deg);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        
        .student-card.in-line {
            border-color: #f59e0b;
            background: linear-gradient(145deg, #fffbeb, #fef3c7);
        }
        
        .student-card.at-front {
            border-color: #10b981;
            background: linear-gradient(145deg, #ecfdf5, #d1fae5);
            animation: pulse-green 2s infinite;
        }
        
        .student-card.completed {
            border-color: #6b7280;
            background: linear-gradient(145deg, #f9fafb, #e5e7eb);
            opacity: 0.7;
        }
        
        .student-card.absent {
            border-color: #ef4444;
            background: linear-gradient(145deg, #fef2f2, #fee2e2);
        }
        
        @keyframes pulse-green {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            }
            50% { 
                box-shadow: 0 0 40px rgba(16, 185, 129, 0.8);
            }
        }
        
        .class-card {
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }
        
        .class-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }
        
        .class-card.active {
            border-color: #10b981;
            background: linear-gradient(145deg, #ecfdf5, #d1fae5);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: rotate 4s linear infinite;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-card:hover {
            transform: scale(1.08) rotateZ(2deg);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        
        .input-modern {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        
        .input-modern:focus {
            border-color: #667eea;
            box-shadow: 0 0 25px rgba(102, 126, 234, 0.3);
            background: rgba(255, 255, 255, 1);
            transform: scale(1.02);
        }
        
        .section-header {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .nav-item {
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 4px;
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .nav-item.active::after,
        .nav-item:hover::after {
            width: 100%;
        }
        
        .position-number {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .grade-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .behavior-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .behavior-excellent {
            background: #10b981;
        }
        
        .behavior-good {
            background: #3b82f6;
        }
        
        .behavior-needs-improvement {
            background: #f59e0b;
        }
        
        .behavior-poor {
            background: #ef4444;
        }
        
        .real-time-clock {
            background: linear-gradient(135deg, #1f2937, #374151);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .hidden {
            display: none !important;
        }
        
        .show {
            display: flex !important;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .icon-bounce {
            animation: bounce 3s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .sparkle-effect {
            position: relative;
        }
        
        .sparkle-effect::after {
            content: '⭐';
            position: absolute;
            top: -15px;
            right: -15px;
            animation: sparkle 3s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0.5) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
        }
        
        /* تحسينات الاستجابة */
        @media (max-width: 768px) {
            .card-modern {
                border-radius: 20px;
                margin: 15px;
            }
            
            .student-card, .class-card {
                border-radius: 18px;
            }
            
            .section-header {
                border-radius: 20px;
                margin: 15px;
            }
            
            .position-number {
                font-size: 2rem;
            }
        }
        
        .notification-sound {
            display: inline-block;
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0 2px;
            animation: sound-wave 1.5s infinite ease-in-out;
        }
        
        .notification-sound:nth-child(2) { animation-delay: 0.1s; }
        .notification-sound:nth-child(3) { animation-delay: 0.2s; }
        .notification-sound:nth-child(4) { animation-delay: 0.3s; }
        
        @keyframes sound-wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="relative overflow-hidden">
        <div class="glass-effect py-8">
            <div class="container mx-auto px-6">
                <!-- الصف الأول: الشعارات والعنوان الرئيسي -->
                <div class="flex items-center justify-center mb-8">
                    <!-- الشعار الأيسر -->
                    <div class="w-20 h-20 rounded-full glass-effect flex items-center justify-center pulse-glow mx-8" id="leftLogoContainer">
                        <div id="leftLogoDisplay" class="w-full h-full rounded-full overflow-hidden flex items-center justify-center">
                            <i class="fas fa-image text-xl text-white opacity-50"></i>
                        </div>
                    </div>
                    
                    <!-- العنوان الرئيسي -->
                    <div class="text-center text-white mx-8">
                        <h1 class="text-4xl md:text-6xl font-bold floating-animation mb-3">
                            <i class="fas fa-users-line mr-4 text-5xl"></i>
                            الطابور المدرسي
                        </h1>
                        <p class="text-xl md:text-2xl opacity-90 font-semibold mb-4">انضباط يعكس وعيًا ونظام يصنع الأجيال</p>
                        
                        <!-- النجوم الزخرفية -->
                        <div class="flex items-center justify-center space-x-3 space-x-reverse mt-4">
                            <div class="w-10 h-10 rounded-full glass-effect flex items-center justify-center pulse-glow transform hover:scale-110 transition-all duration-300">
                                <i class="fas fa-star text-lg text-amber-400 floating-animation"></i>
                            </div>
                            <div class="w-12 h-12 rounded-full glass-effect flex items-center justify-center pulse-glow transform hover:scale-110 transition-all duration-300">
                                <i class="fas fa-trophy text-xl text-yellow-400 floating-animation"></i>
                            </div>
                            <div class="w-14 h-14 rounded-full glass-effect flex items-center justify-center pulse-glow transform hover:scale-110 transition-all duration-300">
                                <i class="fas fa-crown text-2xl text-gold-400 floating-animation" style="color: #FFD700;"></i>
                            </div>
                            <div class="w-12 h-12 rounded-full glass-effect flex items-center justify-center pulse-glow transform hover:scale-110 transition-all duration-300">
                                <i class="fas fa-medal text-xl text-orange-400 floating-animation"></i>
                            </div>
                            <div class="w-10 h-10 rounded-full glass-effect flex items-center justify-center pulse-glow transform hover:scale-110 transition-all duration-300">
                                <i class="fas fa-gem text-lg text-purple-400 floating-animation"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الشعار الأيمن -->
                    <div class="w-20 h-20 rounded-full glass-effect flex items-center justify-center pulse-glow mx-8" id="rightLogoContainer">
                        <div id="rightLogoDisplay" class="w-full h-full rounded-full overflow-hidden flex items-center justify-center">
                            <i class="fas fa-image text-xl text-white opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <!-- الصف الثاني: التاريخ والوقت في مستطيل صغير -->
                <div class="flex justify-center mb-8">
                    <div class="glass-effect rounded-2xl px-8 py-4 text-white text-center">
                        <div class="flex items-center space-x-8 space-x-reverse">
                            <!-- اليوم -->
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                                    <i class="fas fa-calendar-day text-sm text-white"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold opacity-80">اليوم</p>
                                    <p class="text-lg font-bold" id="currentDay">الأحد</p>
                                </div>
                            </div>
                            
                            <!-- خط فاصل -->
                            <div class="w-px h-12 bg-white opacity-30"></div>
                            
                            <!-- التاريخ -->
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center">
                                    <i class="fas fa-calendar-alt text-sm text-white"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold opacity-80">التاريخ</p>
                                    <p class="text-lg font-bold" id="currentDate">1445/03/15</p>
                                </div>
                            </div>
                            
                            <!-- خط فاصل -->
                            <div class="w-px h-12 bg-white opacity-30"></div>
                            
                            <!-- الوقت -->
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
                                    <i class="fas fa-clock text-sm text-white"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold opacity-80">الوقت</p>
                                    <p class="text-lg font-bold font-mono" id="realTimeClock">00:00:00</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- الصف الثالث: المعلومات والنجوم -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- النجوم اليومية -->
                    <div class="glass-effect rounded-2xl p-6 text-white">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center">
                                <i class="fas fa-star text-xl text-white"></i>
                            </div>
                            <h4 class="text-lg font-bold text-yellow-300">🌟 نجوم اليوم</h4>
                        </div>
                        <div class="space-y-3">
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                                    <i class="fas fa-star text-lg text-yellow-400"></i>
                                    <span class="text-sm font-bold" id="todayStar">نجمة اليوم: لم يتم التحديد</span>
                                </div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                                    <i class="fas fa-trophy text-lg text-yellow-400"></i>
                                    <span class="text-sm font-bold" id="todayClass">نجم الطابور: لم يتم التحديد</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- معلومات المدرسة -->
                    <div class="glass-effect rounded-2xl p-6 text-white text-center">
                        <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-school text-xl text-white"></i>
                        </div>
                        <h4 class="text-lg font-bold mb-4">معلومات المدرسة</h4>
                        <div class="space-y-2">
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <p class="font-bold text-lg">أ. أحلام بنت علي الحمدانية</p>
                                <p class="text-sm opacity-80">صاحبة الفكرة والإعداد والتصميم</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- النجوم الشهرية -->
                    <div class="glass-effect rounded-2xl p-6 text-white">
                        <div class="text-center mb-4">
                            <div class="w-12 h-12 mx-auto mb-2 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-crown text-xl text-white"></i>
                            </div>
                            <h4 class="text-lg font-bold text-purple-300">👑 نجوم الشهر</h4>
                        </div>
                        <div class="space-y-3">
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                                    <i class="fas fa-crown text-lg text-purple-400"></i>
                                    <span class="text-sm font-bold" id="monthlyStar">نجمة الشهر: لم يتم التحديد</span>
                                </div>
                            </div>
                            <div class="bg-white bg-opacity-10 rounded-lg p-3">
                                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                                    <i class="fas fa-medal text-lg text-purple-400"></i>
                                    <span class="text-sm font-bold" id="monthlyClass">نجم الشهر: لم يتم التحديد</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50">
        <div class="glass-effect py-4">
            <div class="container mx-auto px-6">
                <div class="flex justify-center space-x-8 space-x-reverse flex-wrap gap-3">
                    <button onclick="showSection('attendance')" 
                            class="nav-item bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 flex items-center space-x-3 space-x-reverse active" 
                            id="attendanceBtn">
                        <i class="fas fa-user-check text-2xl"></i>
                        <span>حضور المعلمات</span>
                    </button>
                    <button onclick="showSection('stars')" 
                            class="nav-item bg-yellow-600 hover:bg-yellow-700 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 flex items-center space-x-3 space-x-reverse" 
                            id="starsBtn">
                        <i class="fas fa-star text-2xl"></i>
                        <span>نجم الطابور</span>
                    </button>
                    <button onclick="showSection('admin')" 
                            class="nav-item bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-2xl font-bold text-lg transition-all duration-300 flex items-center space-x-3 space-x-reverse" 
                            id="adminBtn">
                        <i class="fas fa-cog text-2xl"></i>
                        <span>إدارة النظام</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Attendance Section -->
        <section id="attendanceSection" class="section">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-10">
                <div class="stats-card p-8 text-center relative z-10">
                    <div class="text-5xl mb-6">
                        <i class="fas fa-user-check text-green-500"></i>
                    </div>
                    <div class="text-3xl font-bold text-green-600 mb-3" id="presentCount">0</div>
                    <div class="text-gray-700 font-semibold">الحاضرات</div>
                </div>
                <div class="stats-card p-8 text-center relative z-10">
                    <div class="text-5xl mb-6">
                        <i class="fas fa-user-times text-red-500"></i>
                    </div>
                    <div class="text-3xl font-bold text-red-600 mb-3" id="absentCount">0</div>
                    <div class="text-gray-700 font-semibold">الغائبات</div>
                </div>
                <div class="stats-card p-8 text-center relative z-10">
                    <div class="text-5xl mb-6">
                        <i class="fas fa-user-clock text-orange-500"></i>
                    </div>
                    <div class="text-3xl font-bold text-orange-600 mb-3" id="notMarkedCount">0</div>
                    <div class="text-gray-700 font-semibold">لم يتم التسجيل</div>
                </div>
                <div class="stats-card p-8 text-center relative z-10">
                    <div class="text-5xl mb-6">
                        <i class="fas fa-users text-blue-500"></i>
                    </div>
                    <div class="text-3xl font-bold text-blue-600 mb-3" id="totalTeachers">0</div>
                    <div class="text-gray-700 font-semibold">إجمالي المعلمات</div>
                </div>
            </div>

            <!-- Today's Star Display -->
            <div class="section-header p-8 mb-8 text-center">
                <h2 class="text-3xl font-bold gradient-text mb-6 flex items-center justify-center">
                    <i class="fas fa-star mr-4 text-4xl text-yellow-500 icon-bounce"></i>
                    نجمة اليوم
                </h2>
                <div id="todayStarDisplay" class="text-2xl font-bold text-yellow-600">
                    لم يتم تحديد نجمة اليوم بعد
                </div>
            </div>

            <!-- Teachers Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="teachersGrid">
                <!-- Teachers will be populated here -->
            </div>

            <!-- Camera Modal -->
            <div id="cameraModal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
                <div class="card-modern p-8 max-w-2xl w-full mx-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">تصوير الطابور</h3>
                        <button onclick="closeCameraModal()" class="text-gray-500 hover:text-gray-700 text-3xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-center">
                        <video id="cameraVideo" width="400" height="300" autoplay class="rounded-lg mb-4"></video>
                        <canvas id="cameraCanvas" width="400" height="300" class="hidden"></canvas>
                        <div class="space-x-4 space-x-reverse">
                            <button onclick="capturePhoto()" class="btn-gradient text-white px-6 py-3 rounded-xl font-bold">
                                <i class="fas fa-camera mr-2"></i>
                                التقاط صورة
                            </button>
                            <button onclick="startCamera()" class="bg-green-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-600">
                                <i class="fas fa-video mr-2"></i>
                                تشغيل الكاميرا
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stars Section -->
        <section id="starsSection" class="section hidden">
            <div class="section-header p-8 mb-8">
                <h2 class="text-3xl font-bold gradient-text mb-6 flex items-center">
                    <i class="fas fa-trophy mr-4 text-4xl text-yellow-500 icon-bounce"></i>
                    نجم الطابور - تقييم الصفوف
                </h2>
            </div>
            
            <!-- Classes Grid for Rating -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="classRatingGrid">
                <!-- Class rating cards will be populated here -->
            </div>
        </section>

        <!-- Admin Section -->
        <section id="adminSection" class="section hidden">
            <!-- Login Modal -->
            <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div class="card-modern p-8 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-lock text-4xl text-purple-600 mb-4"></i>
                        <h3 class="text-2xl font-bold">تسجيل دخول المدير</h3>
                    </div>
                    <div class="space-y-4">
                        <input type="password" id="adminPassword" placeholder="كلمة المرور" 
                               class="input-modern w-full px-4 py-3 text-lg" onkeypress="if(event.key==='Enter') adminLogin()">
                        <button onclick="adminLogin()" 
                                class="btn-gradient w-full text-white px-6 py-3 rounded-xl font-bold">
                            <i class="fas fa-sign-in-alt mr-2"></i>
                            دخول
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Content -->
            <div id="adminContent" class="hidden">
                <!-- Teacher Management -->
                <div class="card-modern p-8 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-users mr-4 text-blue-500"></i>
                        إدارة المعلمات
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Manual Add -->
                        <div>
                            <h4 class="text-lg font-bold mb-4">إضافة معلمة يدوياً</h4>
                            <div class="space-y-4">
                                <input type="text" id="teacherName" placeholder="اسم المعلمة" 
                                       class="input-modern w-full px-4 py-3">
                                <input type="text" id="teacherClass" placeholder="الصف المشرفة عليه" 
                                       class="input-modern w-full px-4 py-3">
                                <button onclick="addTeacher()" 
                                        class="btn-gradient w-full text-white px-6 py-3 rounded-xl font-bold">
                                    <i class="fas fa-plus mr-2"></i>
                                    إضافة معلمة
                                </button>
                            </div>
                        </div>
                        
                        <!-- Excel Upload -->
                        <div>
                            <h4 class="text-lg font-bold mb-4">رفع ملف Excel للمعلمات</h4>
                            <div class="space-y-4">
                                <input type="file" id="excelFile" accept=".xlsx,.xls" 
                                       class="input-modern w-full px-4 py-3" onchange="handleExcelUpload(event)">
                                <p class="text-sm text-gray-600">
                                    يجب أن يحتوي الملف على عمودين: اسم المعلمة والصف
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classes Management -->
                <div class="card-modern p-8 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-school mr-4 text-green-500"></i>
                        إدارة الصفوف
                    </h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Manual Add Class -->
                        <div>
                            <h4 class="text-lg font-bold mb-4">إضافة صف يدوياً</h4>
                            <div class="space-y-4">
                                <input type="text" id="className" placeholder="اسم الصف (مثل: خامس أول)" 
                                       class="input-modern w-full px-4 py-3">
                                <button onclick="addClass()" 
                                        class="btn-gradient w-full text-white px-6 py-3 rounded-xl font-bold">
                                    <i class="fas fa-plus mr-2"></i>
                                    إضافة صف
                                </button>
                            </div>
                        </div>
                        
                        <!-- Excel Upload for Classes -->
                        <div>
                            <h4 class="text-lg font-bold mb-4">رفع ملف Excel للصفوف</h4>
                            <div class="space-y-4">
                                <input type="file" id="classesExcelFile" accept=".xlsx,.xls" 
                                       class="input-modern w-full px-4 py-3" onchange="handleClassesExcelUpload(event)">
                                <p class="text-sm text-gray-600">
                                    يجب أن يحتوي الملف على عمود واحد: اسم الصف
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stars Management -->
                <div class="card-modern p-8 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-star mr-4 text-yellow-500"></i>
                        إدارة النجوم
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-bold mb-4">نجوم المعلمات</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2">نجمة اليوم</label>
                                    <select id="dailyTeacherStar" class="input-modern w-full px-4 py-3">
                                        <option value="">اختر المعلمة</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">نجمة الأسبوع</label>
                                    <select id="weeklyTeacherStar" class="input-modern w-full px-4 py-3">
                                        <option value="">اختر المعلمة</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">نجمة الشهر</label>
                                    <select id="monthlyTeacherStar" class="input-modern w-full px-4 py-3">
                                        <option value="">اختر المعلمة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-bold mb-4">نجوم الصفوف</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold mb-2">نجم الطابور اليوم</label>
                                    <select id="dailyClassStar" class="input-modern w-full px-4 py-3">
                                        <option value="">اختر الصف</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">نجم الطابور الأسبوع</label>
                                    <select id="weeklyClassStar" class="input-modern w-full px-4 py-3">
                                        <option value="">اختر الصف</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">نجم الطابور الشهر</label>
                                    <select id="monthlyClassStar" class="input-modern w-full px-4 py-3">
                                        <option value="">اختر الصف</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveStarSelections()" 
                            class="btn-gradient text-white px-8 py-3 rounded-xl font-bold mt-6">
                        <i class="fas fa-save mr-2"></i>
                        حفظ التحديدات
                    </button>
                </div>

                <!-- Certificates -->
                <div class="card-modern p-8 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-certificate mr-4 text-green-500"></i>
                        طباعة الشهادات
                    </h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <button onclick="printCertificate('daily-teacher')" 
                                class="bg-yellow-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-yellow-600 flex flex-col items-center">
                            <i class="fas fa-star text-2xl mb-2"></i>
                            <span class="text-sm">نجمة اليوم</span>
                        </button>
                        <button onclick="printCertificate('weekly-teacher')" 
                                class="bg-blue-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-blue-600 flex flex-col items-center">
                            <i class="fas fa-star text-2xl mb-2"></i>
                            <span class="text-sm">نجمة الأسبوع</span>
                        </button>
                        <button onclick="printCertificate('monthly-teacher')" 
                                class="bg-purple-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-purple-600 flex flex-col items-center">
                            <i class="fas fa-star text-2xl mb-2"></i>
                            <span class="text-sm">نجمة الشهر</span>
                        </button>
                        <button onclick="printCertificate('daily-class')" 
                                class="bg-orange-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-orange-600 flex flex-col items-center">
                            <i class="fas fa-trophy text-2xl mb-2"></i>
                            <span class="text-sm">نجم اليوم</span>
                        </button>
                        <button onclick="printCertificate('weekly-class')" 
                                class="bg-green-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-green-600 flex flex-col items-center">
                            <i class="fas fa-trophy text-2xl mb-2"></i>
                            <span class="text-sm">نجم الأسبوع</span>
                        </button>
                        <button onclick="printCertificate('monthly-class')" 
                                class="bg-red-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-red-600 flex flex-col items-center">
                            <i class="fas fa-trophy text-2xl mb-2"></i>
                            <span class="text-sm">نجم الشهر</span>
                        </button>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="card-modern p-8 mb-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-cog mr-4 text-gray-500"></i>
                        إعدادات النظام
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="text-lg font-bold mb-4">بيانات المدرسة</h4>
                            <div class="space-y-4">
                                <input type="text" id="schoolName" placeholder="اسم المدرسة" 
                                       class="input-modern w-full px-4 py-3">
                                <input type="text" id="principalName" placeholder="اسم المديرة" 
                                       class="input-modern w-full px-4 py-3">
                                <div>
                                    <label class="block text-sm font-bold mb-2">الشعار الأيسر</label>
                                    <input type="file" id="leftLogo" accept="image/*" 
                                           class="input-modern w-full px-4 py-3" onchange="handleLogoUpload('left', event)">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-2">الشعار الأيمن</label>
                                    <input type="file" id="rightLogo" accept="image/*" 
                                           class="input-modern w-full px-4 py-3" onchange="handleLogoUpload('right', event)">
                                </div>
                                <input type="file" id="schoolLogo" accept="image/*" 
                                       class="input-modern w-full px-4 py-3">
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-bold mb-4">الأمان</h4>
                            <div class="space-y-4">
                                <input type="password" id="newPassword" placeholder="كلمة مرور جديدة" 
                                       class="input-modern w-full px-4 py-3">
                                <input type="password" id="confirmPassword" placeholder="تأكيد كلمة المرور" 
                                       class="input-modern w-full px-4 py-3">
                                <button onclick="changePassword()" 
                                        class="btn-gradient w-full text-white px-6 py-3 rounded-xl font-bold">
                                    <i class="fas fa-key mr-2"></i>
                                    تغيير كلمة المرور
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="saveSystemSettings()" 
                            class="btn-gradient text-white px-8 py-3 rounded-xl font-bold mt-6">
                        <i class="fas fa-save mr-2"></i>
                        حفظ الإعدادات
                    </button>
                </div>

                <!-- Data Management -->
                <div class="card-modern p-8">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-database mr-4 text-red-500"></i>
                        إدارة البيانات
                    </h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="exportDailyReport()" 
                                class="bg-blue-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-blue-600 flex flex-col items-center">
                            <i class="fas fa-file-pdf text-2xl mb-2"></i>
                            <span class="text-sm">تقرير يومي PDF</span>
                        </button>
                        <button onclick="exportMonthlyReport()" 
                                class="bg-green-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-green-600 flex flex-col items-center">
                            <i class="fas fa-file-pdf text-2xl mb-2"></i>
                            <span class="text-sm">تقرير شهري PDF</span>
                        </button>
                        <button onclick="exportDailyExcel()" 
                                class="bg-emerald-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-emerald-600 flex flex-col items-center">
                            <i class="fas fa-file-excel text-2xl mb-2"></i>
                            <span class="text-sm">تقرير يومي Excel</span>
                        </button>
                        <button onclick="exportMonthlyExcel()" 
                                class="bg-teal-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-teal-600 flex flex-col items-center">
                            <i class="fas fa-file-excel text-2xl mb-2"></i>
                            <span class="text-sm">تقرير شهري Excel</span>
                        </button>
                        <button onclick="backupData()" 
                                class="bg-purple-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-purple-600 flex flex-col items-center">
                            <i class="fas fa-download text-2xl mb-2"></i>
                            <span class="text-sm">نسخ احتياطي</span>
                        </button>
                        <button onclick="restoreData()" 
                                class="bg-orange-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-orange-600 flex flex-col items-center">
                            <i class="fas fa-upload text-2xl mb-2"></i>
                            <span class="text-sm">استعادة البيانات</span>
                        </button>
                        <button onclick="clearAllData()" 
                                class="bg-red-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-red-600 flex flex-col items-center">
                            <i class="fas fa-trash text-2xl mb-2"></i>
                            <span class="text-sm">مسح البيانات</span>
                        </button>
                        <button onclick="resetSystem()" 
                                class="bg-gray-500 text-white px-4 py-6 rounded-xl font-bold hover:bg-gray-600 flex flex-col items-center">
                            <i class="fas fa-redo text-2xl mb-2"></i>
                            <span class="text-sm">إعادة تعيين</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Hidden file input for restore -->
    <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="handleRestoreFile(event)">

    <script>
        // Global Variables
        let teachers = JSON.parse(localStorage.getItem('school_teachers')) || [];
        let classes = JSON.parse(localStorage.getItem('school_classes')) || [];
        let attendance = JSON.parse(localStorage.getItem('school_attendance')) || {};
        let classRatings = JSON.parse(localStorage.getItem('school_class_ratings')) || {};
        let systemSettings = JSON.parse(localStorage.getItem('school_system_settings')) || {
            adminPassword: '123456',
            schoolName: 'مدرسة النموذجية',
            principalName: 'أ. أحلام بنت علي الحمدانية',
            schoolLogo: null,
            leftLogo: null,
            rightLogo: null
        };
        let stars = JSON.parse(localStorage.getItem('school_stars')) || {
            dailyTeacher: null,
            weeklyTeacher: null,
            monthlyTeacher: null,
            dailyClass: null,
            weeklyClass: null,
            monthlyClass: null
        };
        
        let isAdminLoggedIn = false;
        let currentDate = new Date().toDateString();

        // Initialize the application
        function init() {
            updateRealTimeClock();
            setInterval(updateRealTimeClock, 1000);
            
            // Check if it's a new day and reset attendance
            checkNewDay();
            
            if (teachers.length === 0) {
                addSampleTeachers();
            }
            
            renderAttendance();
            renderStars();
            updateStatistics();
            updateStarSelects();
            updateLogosDisplay();
            showSection('attendance');
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                renderAttendance();
                updateStatistics();
            }, 30000);
        }

        // Handle logo upload
        function handleLogoUpload(position, event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showErrorMessage('يرجى اختيار ملف صورة صحيح');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (position === 'left') {
                    systemSettings.leftLogo = e.target.result;
                } else if (position === 'right') {
                    systemSettings.rightLogo = e.target.result;
                }
                
                saveData();
                updateLogosDisplay();
                showSuccessMessage(`تم رفع الشعار ${position === 'left' ? 'الأيسر' : 'الأيمن'} بنجاح`);
            };
            reader.readAsDataURL(file);
        }

        // Update logos display in header
        function updateLogosDisplay() {
            const leftLogoDisplay = document.getElementById('leftLogoDisplay');
            const rightLogoDisplay = document.getElementById('rightLogoDisplay');
            
            if (systemSettings.leftLogo) {
                leftLogoDisplay.innerHTML = `<img src="${systemSettings.leftLogo}" alt="الشعار الأيسر" class="w-full h-full object-cover rounded-full">`;
            } else {
                leftLogoDisplay.innerHTML = '<i class="fas fa-image text-2xl text-white opacity-50"></i>';
            }
            
            if (systemSettings.rightLogo) {
                rightLogoDisplay.innerHTML = `<img src="${systemSettings.rightLogo}" alt="الشعار الأيمن" class="w-full h-full object-cover rounded-full">`;
            } else {
                rightLogoDisplay.innerHTML = '<i class="fas fa-image text-2xl text-white opacity-50"></i>';
            }
        }

        // Check if it's a new day
        function checkNewDay() {
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('school_last_date');
            
            if (lastDate !== today) {
                // Reset daily attendance
                attendance = {};
                stars.dailyTeacher = null;
                localStorage.setItem('school_last_date', today);
                saveData();
            }
        }

        // Add sample teachers
        function addSampleTeachers() {
            const sampleTeachers = [
                { id: 1, name: 'أ. فاطمة أحمد', className: 'خامس أول', photo: null },
                { id: 2, name: 'أ. عائشة محمد', className: 'خامس ثاني', photo: null },
                { id: 3, name: 'أ. خديجة علي', className: 'سادس أول', photo: null },
                { id: 4, name: 'أ. مريم سالم', className: 'سادس ثاني', photo: null },
                { id: 5, name: 'أ. زينب حسن', className: 'رابع أول', photo: null },
                { id: 6, name: 'أ. أسماء يوسف', className: 'رابع ثاني', photo: null }
            ];
            
            teachers = sampleTeachers;
            
            // Initialize class ratings
            sampleTeachers.forEach(teacher => {
                if (!classRatings[teacher.className]) {
                    classRatings[teacher.className] = {
                        speed: 0,
                        quiet: 0,
                        cleanliness: 0,
                        total: 0
                    };
                }
            });
            
            saveData();
        }

        // Add sample data
        function addSampleData() {
            const sampleClasses = [
                { id: 1, name: '1أ', grade: 'الأول', teacher: 'أ. فاطمة أحمد', capacity: 25, currentStudents: 23, status: 'active' },
                { id: 2, name: '2ب', grade: 'الثاني', teacher: 'أ. محمد علي', capacity: 28, currentStudents: 26, status: 'active' },
                { id: 3, name: '3ج', grade: 'الثالث', teacher: 'أ. عائشة سالم', capacity: 30, currentStudents: 28, status: 'active' }
            ];
            
            const sampleStudents = [
                { id: 1, name: 'أحمد محمد', studentId: 'S001', classId: 1, className: '1أ', behavior: 'excellent', status: 'in-line', position: 1, joinTime: new Date() },
                { id: 2, name: 'فاطمة علي', studentId: 'S002', classId: 1, className: '1أ', behavior: 'good', status: 'in-line', position: 2, joinTime: new Date() },
                { id: 3, name: 'محمد سالم', studentId: 'S003', classId: 2, className: '2ب', behavior: 'excellent', status: 'at-front', position: 1, joinTime: new Date() }
            ];
            
            const sampleActivities = [
                { id: 1, name: 'الأنشطة الرياضية', type: 'sports', participants: 15, maxCapacity: 30, status: 'active', startTime: new Date() },
                { id: 2, name: 'المكتبة', type: 'library', participants: 8, maxCapacity: 20, status: 'active', startTime: new Date() }
            ];
            
            classes = sampleClasses;
            students = sampleStudents;
            activities = sampleActivities;
            
            saveData();
        }

        // Real-time clock and date
        function updateRealTimeClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-SA', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Update time
            document.getElementById('realTimeClock').textContent = timeString;
            
            // Update day
            const dayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            const currentDayElement = document.getElementById('currentDay');
            if (currentDayElement) {
                currentDayElement.textContent = dayNames[now.getDay()];
            }
            
            // Update date
            const dateString = now.toLocaleDateString('ar-SA-u-nu-latn', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const currentDateElement = document.getElementById('currentDate');
            if (currentDateElement) {
                currentDateElement.textContent = dateString;
            }
        }

        // Show section
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => {
                s.classList.add('hidden');
            });
            
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.getElementById(section + 'Btn').classList.add('active');
            
            if (section === 'attendance') {
                renderAttendance();
                updateStatistics();
            } else if (section === 'stars') {
                renderStars();
            } else if (section === 'admin') {
                if (!isAdminLoggedIn) {
                    document.getElementById('loginModal').style.display = 'flex';
                } else {
                    document.getElementById('adminContent').classList.remove('hidden');
                    updateStarSelects();
                }
            }
        }

        // Update header stars display
        function updateHeaderStars() {
            const todayStarElement = document.getElementById('todayStar');
            const todayClassElement = document.getElementById('todayClass');
            const monthlyStarElement = document.getElementById('monthlyStar');
            const monthlyClassElement = document.getElementById('monthlyClass');
            const todayStarDisplay = document.getElementById('todayStarDisplay');
            
            // نجمة اليوم
            if (stars.dailyTeacher) {
                const teacher = teachers.find(t => t.id === stars.dailyTeacher);
                todayStarElement.textContent = `نجمة اليوم: ${teacher ? teacher.name : 'غير محدد'}`;
                if (todayStarDisplay) {
                    todayStarDisplay.textContent = teacher ? teacher.name : 'غير محدد';
                }
            } else {
                todayStarElement.textContent = 'نجمة اليوم: لم يتم التحديد';
                if (todayStarDisplay) {
                    todayStarDisplay.textContent = 'لم يتم تحديد نجمة اليوم بعد';
                }
            }
            
            // نجم الطابور اليوم
            if (stars.dailyClass) {
                todayClassElement.textContent = `نجم الطابور: ${stars.dailyClass}`;
            } else {
                // Find best class based on total points
                let bestClass = null;
                let maxPoints = -1;
                
                Object.keys(classRatings).forEach(className => {
                    const rating = classRatings[className];
                    if (rating.total > maxPoints) {
                        maxPoints = rating.total;
                        bestClass = className;
                    }
                });
                
                todayClassElement.textContent = bestClass ? `نجم الطابور: ${bestClass}` : 'نجم الطابور: لم يتم التحديد';
            }
            
            // نجمة الشهر
            if (monthlyStarElement) {
                if (stars.monthlyTeacher) {
                    const teacher = teachers.find(t => t.id === stars.monthlyTeacher);
                    monthlyStarElement.textContent = `نجمة الشهر: ${teacher ? teacher.name : 'غير محدد'}`;
                } else {
                    monthlyStarElement.textContent = 'نجمة الشهر: لم يتم التحديد';
                }
            }
            
            // نجم الشهر
            if (monthlyClassElement) {
                if (stars.monthlyClass) {
                    monthlyClassElement.textContent = `نجم الشهر: ${stars.monthlyClass}`;
                } else {
                    monthlyClassElement.textContent = 'نجم الشهر: لم يتم التحديد';
                }
            }
        }

        // Attendance functions
        function markAttendance(teacherId, status) {
            const teacher = teachers.find(t => t.id === teacherId);
            if (!teacher) return;
            
            attendance[teacherId] = {
                status: status,
                time: new Date().toLocaleTimeString('ar-SA'),
                date: new Date().toDateString()
            };
            
            // Set daily star if this is the first present teacher
            if (status === 'present' && !stars.dailyTeacher) {
                stars.dailyTeacher = teacherId;
                showSuccessMessage(`🌟 ${teacher.name} هي نجمة اليوم! 🌟`);
            }
            
            saveData();
            renderAttendance();
            updateStatistics();
            updateHeaderStars();
        }

        function resetAttendance(teacherId) {
            if (attendance[teacherId]) {
                delete attendance[teacherId];
                
                // Reset daily star if this teacher was the star
                if (stars.dailyTeacher === teacherId) {
                    stars.dailyTeacher = null;
                }
                
                saveData();
                renderAttendance();
                updateStatistics();
                updateHeaderStars();
            }
        }

        // Teacher management
        function addTeacher() {
            const name = document.getElementById('teacherName').value.trim();
            const className = document.getElementById('teacherClass').value.trim();
            
            if (!name || !className) {
                showErrorMessage('يرجى إدخال اسم المعلمة والصف');
                return;
            }
            
            const newTeacher = {
                id: Date.now(),
                name: name,
                className: className,
                photo: null
            };
            
            teachers.push(newTeacher);
            
            // Add class to classes array if not exists
            if (!classes.includes(className)) {
                classes.push(className);
            }
            
            // Initialize class rating
            if (!classRatings[className]) {
                classRatings[className] = {
                    speed: 0,
                    quiet: 0,
                    cleanliness: 0,
                    total: 0
                };
            }
            
            saveData();
            renderAttendance();
            renderStars();
            updateStarSelects();
            
            // Clear form
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherClass').value = '';
            
            showSuccessMessage(`تم إضافة المعلمة ${name} بنجاح`);
        }

        // Class management
        function addClass() {
            const className = document.getElementById('className').value.trim();
            
            if (!className) {
                showErrorMessage('يرجى إدخال اسم الصف');
                return;
            }
            
            if (classes.includes(className)) {
                showErrorMessage('هذا الصف موجود بالفعل');
                return;
            }
            
            classes.push(className);
            
            // Initialize class rating
            if (!classRatings[className]) {
                classRatings[className] = {
                    speed: 0,
                    quiet: 0,
                    cleanliness: 0,
                    total: 0
                };
            }
            
            saveData();
            renderStars();
            updateStarSelects();
            
            // Clear form
            document.getElementById('className').value = '';
            
            showSuccessMessage(`تم إضافة الصف ${className} بنجاح`);
        }

        // Classes Excel upload handler
        function handleClassesExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    let addedClasses = 0;
                    
                    // Process Excel data
                    for (let i = 1; i < jsonData.length; i++) { // Skip header row
                        const row = jsonData[i];
                        if (row[0]) { // Class name column
                            const className = row[0].toString().trim();
                            
                            if (!classes.includes(className)) {
                                classes.push(className);
                                addedClasses++;
                                
                                // Initialize class rating
                                if (!classRatings[className]) {
                                    classRatings[className] = {
                                        speed: 0,
                                        quiet: 0,
                                        cleanliness: 0,
                                        total: 0
                                    };
                                }
                            }
                        }
                    }
                    
                    saveData();
                    renderStars();
                    updateStarSelects();
                    
                    showSuccessMessage(`تم رفع ${addedClasses} صف من ملف Excel`);
                    
                } catch (error) {
                    showErrorMessage('خطأ في قراءة ملف Excel. تأكد من صحة التنسيق');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Excel upload handler
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Clear existing teachers
                    teachers = [];
                    classRatings = {};
                    
                    // Process Excel data
                    for (let i = 1; i < jsonData.length; i++) { // Skip header row
                        const row = jsonData[i];
                        if (row[0] && row[1]) { // Name and class columns
                            const teacher = {
                                id: Date.now() + i,
                                name: row[0].toString().trim(),
                                className: row[1].toString().trim(),
                                photo: null
                            };
                            
                            teachers.push(teacher);
                            
                            // Initialize class rating
                            if (!classRatings[teacher.className]) {
                                classRatings[teacher.className] = {
                                    speed: 0,
                                    quiet: 0,
                                    cleanliness: 0,
                                    total: 0
                                };
                            }
                        }
                    }
                    
                    saveData();
                    renderAttendance();
                    renderStars();
                    updateStarSelects();
                    
                    showSuccessMessage(`تم رفع ${teachers.length} معلمة من ملف Excel`);
                    
                } catch (error) {
                    showErrorMessage('خطأ في قراءة ملف Excel. تأكد من صحة التنسيق');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Class rating functions
        function updateClassRating(className, criterion, change) {
            if (!classRatings[className]) {
                classRatings[className] = { speed: 0, quiet: 0, cleanliness: 0, total: 0 };
            }
            
            classRatings[className][criterion] = Math.max(0, classRatings[className][criterion] + change);
            classRatings[className].total = classRatings[className].speed + 
                                          classRatings[className].quiet + 
                                          classRatings[className].cleanliness;
            
            saveData();
            renderStars();
            updateHeaderStars();
        }

        // Admin functions
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === systemSettings.adminPassword) {
                isAdminLoggedIn = true;
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('adminContent').classList.remove('hidden');
                updateStarSelects();
                loadSystemSettings();
                showSuccessMessage('تم تسجيل الدخول بنجاح');
            } else {
                showErrorMessage('كلمة المرور غير صحيحة');
            }
            
            document.getElementById('adminPassword').value = '';
        }

        function saveStarSelections() {
            stars.dailyTeacher = parseInt(document.getElementById('dailyTeacherStar').value) || null;
            stars.weeklyTeacher = parseInt(document.getElementById('weeklyTeacherStar').value) || null;
            stars.monthlyTeacher = parseInt(document.getElementById('monthlyTeacherStar').value) || null;
            stars.dailyClass = document.getElementById('dailyClassStar').value || null;
            stars.weeklyClass = document.getElementById('weeklyClassStar').value || null;
            stars.monthlyClass = document.getElementById('monthlyClassStar').value || null;
            
            saveData();
            updateHeaderStars();
            showSuccessMessage('تم حفظ تحديدات النجوم بنجاح');
        }

        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showErrorMessage('يرجى إدخال كلمة المرور الجديدة وتأكيدها');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showErrorMessage('كلمة المرور وتأكيدها غير متطابقتين');
                return;
            }
            
            if (newPassword.length < 6) {
                showErrorMessage('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return;
            }
            
            systemSettings.adminPassword = newPassword;
            saveData();
            
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showSuccessMessage('تم تغيير كلمة المرور بنجاح');
        }

        function saveSystemSettings() {
            systemSettings.schoolName = document.getElementById('schoolName').value || systemSettings.schoolName;
            systemSettings.principalName = document.getElementById('principalName').value || systemSettings.principalName;
            
            const logoFile = document.getElementById('schoolLogo').files[0];
            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    systemSettings.schoolLogo = e.target.result;
                    saveData();
                };
                reader.readAsDataURL(logoFile);
            }
            
            saveData();
            showSuccessMessage('تم حفظ إعدادات النظام بنجاح');
        }

        function loadSystemSettings() {
            document.getElementById('schoolName').value = systemSettings.schoolName;
            document.getElementById('principalName').value = systemSettings.principalName;
        }

        // Camera functions
        function openCameraModal() {
            document.getElementById('cameraModal').classList.add('show');
        }

        function closeCameraModal() {
            document.getElementById('cameraModal').classList.remove('show');
            const video = document.getElementById('cameraVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    document.getElementById('cameraVideo').srcObject = stream;
                })
                .catch(err => {
                    showErrorMessage('لا يمكن الوصول إلى الكاميرا');
                });
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/png');
            
            // Save photo (you can implement saving logic here)
            showSuccessMessage('تم التقاط الصورة بنجاح');
            closeCameraModal();
        }

        // Export functions
        async function exportDailyReport() {
            try {
                const reportData = generateDailyReportData();
                const reportElement = createReportElement(reportData, 'تقرير الحضور اليومي');
                
                const canvas = await html2canvas(reportElement, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`تقرير_يومي_${new Date().toLocaleDateString('ar-SA')}.pdf`);
                
                document.body.removeChild(reportElement);
                showSuccessMessage('تم تصدير التقرير اليومي بنجاح');
            } catch (error) {
                showErrorMessage('خطأ في تصدير التقرير');
            }
        }

        async function exportMonthlyReport() {
            try {
                const reportData = generateMonthlyReportData();
                const reportElement = createReportElement(reportData, 'التقرير الشهري');
                
                const canvas = await html2canvas(reportElement, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`التقرير_الشهري_${new Date().toLocaleDateString('ar-SA')}.pdf`);
                
                document.body.removeChild(reportElement);
                showSuccessMessage('تم تصدير التقرير الشهري بنجاح');
            } catch (error) {
                showErrorMessage('خطأ في تصدير التقرير الشهري');
            }
        }

        function exportDailyExcel() {
            const reportData = generateDailyReportData();
            const ws = XLSX.utils.json_to_sheet(reportData.tableData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'التقرير اليومي');
            XLSX.writeFile(wb, `تقرير_يومي_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
            showSuccessMessage('تم تصدير التقرير اليومي إلى Excel');
        }

        function exportMonthlyExcel() {
            const reportData = generateMonthlyReportData();
            const ws = XLSX.utils.json_to_sheet(reportData.tableData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'التقرير الشهري');
            XLSX.writeFile(wb, `التقرير_الشهري_${new Date().toLocaleDateString('ar-SA')}.xlsx`);
            showSuccessMessage('تم تصدير التقرير الشهري إلى Excel');
        }

        function generateDailyReportData() {
            const today = new Date().toLocaleDateString('ar-SA');
            const tableData = teachers.map(teacher => {
                const att = attendance[teacher.id];
                return {
                    'اسم المعلمة': teacher.name,
                    'الصف': teacher.className,
                    'الحالة': att ? (att.status === 'present' ? 'حاضرة' : 'غائبة') : 'لم يتم التسجيل',
                    'وقت الحضور': att ? att.time : '-'
                };
            });
            
            return {
                title: 'تقرير الحضور اليومي',
                date: today,
                tableData: tableData,
                summary: {
                    total: teachers.length,
                    present: Object.values(attendance).filter(a => a.status === 'present').length,
                    absent: Object.values(attendance).filter(a => a.status === 'absent').length
                }
            };
        }

        function generateMonthlyReportData() {
            const month = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' });
            const tableData = teachers.map(teacher => {
                return {
                    'اسم المعلمة': teacher.name,
                    'الصف': teacher.className,
                    'أيام الحضور': Math.floor(Math.random() * 20) + 10, // Simulated data
                    'أيام الغياب': Math.floor(Math.random() * 5),
                    'معدل الحضور': Math.floor(Math.random() * 20) + 80 + '%'
                };
            });
            
            return {
                title: 'التقرير الشهري',
                date: month,
                tableData: tableData,
                summary: {
                    totalDays: 22,
                    avgAttendance: '92%'
                }
            };
        }

        function createReportElement(data, title) {
            const element = document.createElement('div');
            element.style.cssText = `
                position: absolute;
                top: -9999px;
                left: -9999px;
                width: 800px;
                padding: 40px;
                background: white;
                font-family: 'Noto Sans Arabic', sans-serif;
                direction: rtl;
            `;
            
            element.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">${systemSettings.schoolName}</h1>
                    <h2 style="font-size: 20px; color: #666; margin-bottom: 20px;">${title}</h2>
                    <p style="font-size: 16px;">التاريخ: ${data.date}</p>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            ${Object.keys(data.tableData[0] || {}).map(key => 
                                `<th style="border: 1px solid #ddd; padding: 12px; text-align: center; font-weight: bold;">${key}</th>`
                            ).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.tableData.map(row => 
                            `<tr>${Object.values(row).map(value => 
                                `<td style="border: 1px solid #ddd; padding: 12px; text-align: center;">${value}</td>`
                            ).join('')}</tr>`
                        ).join('')}
                    </tbody>
                </table>
                
                <div style="text-align: center; margin-top: 30px;">
                    <p style="font-size: 14px; color: #666;">تم إنشاء هذا التقرير بواسطة نظام الطابور المدرسي</p>
                    <p style="font-size: 14px; color: #666;">${systemSettings.principalName}</p>
                </div>
            `;
            
            document.body.appendChild(element);
            return element;
        }

        // Certificate and backup functions
        function printCertificate(type) {
            let recipientName = '';
            let certificateTitle = '';
            
            switch(type) {
                case 'daily-teacher':
                    if (stars.dailyTeacher) {
                        const teacher = teachers.find(t => t.id === stars.dailyTeacher);
                        recipientName = teacher ? teacher.name : '';
                        certificateTitle = 'شهادة تقدير - نجمة اليوم';
                    }
                    break;
                case 'weekly-teacher':
                    if (stars.weeklyTeacher) {
                        const teacher = teachers.find(t => t.id === stars.weeklyTeacher);
                        recipientName = teacher ? teacher.name : '';
                        certificateTitle = 'شهادة تقدير - نجمة الأسبوع';
                    }
                    break;
                case 'monthly-teacher':
                    if (stars.monthlyTeacher) {
                        const teacher = teachers.find(t => t.id === stars.monthlyTeacher);
                        recipientName = teacher ? teacher.name : '';
                        certificateTitle = 'شهادة تقدير - نجمة الشهر';
                    }
                    break;
                case 'daily-class':
                    recipientName = stars.dailyClass || '';
                    certificateTitle = 'شهادة تقدير - نجم الطابور اليوم';
                    break;
                case 'weekly-class':
                    recipientName = stars.weeklyClass || '';
                    certificateTitle = 'شهادة تقدير - نجم الطابور الأسبوع';
                    break;
                case 'monthly-class':
                    recipientName = stars.monthlyClass || '';
                    certificateTitle = 'شهادة تقدير - نجم الطابور الشهر';
                    break;
            }
            
            if (!recipientName) {
                showErrorMessage('لم يتم تحديد المستلم للشهادة');
                return;
            }
            
            generateCertificate(recipientName, certificateTitle);
        }

        async function generateCertificate(recipientName, title) {
            const certificateElement = document.createElement('div');
            certificateElement.style.cssText = `
                position: absolute;
                top: -9999px;
                left: -9999px;
                width: 900px;
                height: 700px;
                padding: 40px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
                color: #2c3e50;
                font-family: 'Noto Sans Arabic', sans-serif;
                direction: rtl;
                text-align: center;
                display: flex;
                flex-direction: column;
                justify-content: center;
                border: 8px solid #d4af37;
                box-shadow: 0 0 30px rgba(0,0,0,0.3);
            `;
            
            const logoSection = systemSettings.schoolLogo ? 
                `<div style="margin-bottom: 20px;">
                    <img src="${systemSettings.schoolLogo}" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #d4af37; margin: 0 auto; display: block;">
                </div>` : 
                `<div style="margin-bottom: 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 3px solid #d4af37;">
                        <i class="fas fa-star" style="font-size: 30px; color: white;"></i>
                    </div>
                </div>`;
            
            certificateElement.innerHTML = `
                <div style="background: white; padding: 50px; border-radius: 25px; border: 4px solid #d4af37; box-shadow: inset 0 0 20px rgba(212, 175, 55, 0.2); position: relative;">
                    <!-- زخرفة الزوايا -->
                    <div style="position: absolute; top: 15px; left: 15px; width: 40px; height: 40px; border-top: 4px solid #d4af37; border-left: 4px solid #d4af37;"></div>
                    <div style="position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; border-top: 4px solid #d4af37; border-right: 4px solid #d4af37;"></div>
                    <div style="position: absolute; bottom: 15px; left: 15px; width: 40px; height: 40px; border-bottom: 4px solid #d4af37; border-left: 4px solid #d4af37;"></div>
                    <div style="position: absolute; bottom: 15px; right: 15px; width: 40px; height: 40px; border-bottom: 4px solid #d4af37; border-right: 4px solid #d4af37;"></div>
                    
                    ${logoSection}
                    
                    <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 15px; color: #2c3e50; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">${systemSettings.schoolName}</h1>
                    
                    <div style="margin: 20px 0;">
                        <div style="width: 100px; height: 4px; background: linear-gradient(90deg, #d4af37, #f1c40f, #d4af37); margin: 0 auto; border-radius: 2px;"></div>
                    </div>
                    
                    <h2 style="font-size: 28px; margin-bottom: 30px; color: #8b4513; font-weight: bold;">${title}</h2>
                    
                    <div style="margin: 30px 0;">
                        <p style="font-size: 20px; margin-bottom: 15px; color: #34495e;">تُمنح هذه الشهادة تقديراً وعرفاناً إلى</p>
                        
                        <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 20px; border-radius: 15px; margin: 20px 0; border: 2px solid #d4af37;">
                            <h3 style="font-size: 36px; font-weight: bold; margin: 0; color: #8b4513; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${recipientName}</h3>
                        </div>
                        
                        <p style="font-size: 18px; margin: 25px 0; color: #2c3e50; line-height: 1.6;">وذلك تقديراً لجهودها المتميزة والمثالية في الانضباط والنظام<br>والتزامها بقيم التميز والإبداع</p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 50px; padding-top: 30px; border-top: 2px solid #d4af37;">
                        <div style="text-align: center;">
                            <div style="width: 150px; height: 2px; background: #d4af37; margin-bottom: 10px;"></div>
                            <p style="font-size: 16px; color: #7f8c8d; margin: 5px 0;">التاريخ</p>
                            <p style="font-size: 18px; font-weight: bold; color: #2c3e50;">${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #d4af37, #f1c40f); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-certificate" style="font-size: 24px; color: white;"></i>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="width: 150px; height: 2px; background: #d4af37; margin-bottom: 10px;"></div>
                            <p style="font-size: 18px; font-weight: bold; color: #2c3e50; margin: 5px 0;">${systemSettings.principalName}</p>
                            <p style="font-size: 16px; color: #7f8c8d;">مديرة المدرسة</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(certificateElement);
            
            try {
                const canvas = await html2canvas(certificateElement, {
                    backgroundColor: null,
                    scale: 2
                });
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4');
                
                const imgWidth = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`شهادة_${recipientName}_${new Date().toLocaleDateString('ar-SA')}.pdf`);
                
                showSuccessMessage('تم إنشاء الشهادة بنجاح');
            } catch (error) {
                showErrorMessage('خطأ في إنشاء الشهادة');
            }
            
            document.body.removeChild(certificateElement);
        }

        function backupData() {
            const backupData = {
                teachers: teachers,
                classes: classes,
                attendance: attendance,
                classRatings: classRatings,
                systemSettings: systemSettings,
                stars: stars,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `نسخة_احتياطية_${new Date().toLocaleDateString('ar-SA')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showSuccessMessage('تم إنشاء النسخة الاحتياطية بنجاح');
        }

        function restoreData() {
            document.getElementById('restoreFileInput').click();
        }

        function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (confirm('هل أنت متأكد من استعادة البيانات؟ سيتم حذف البيانات الحالية.')) {
                        teachers = backupData.teachers || [];
                        classes = backupData.classes || [];
                        attendance = backupData.attendance || {};
                        classRatings = backupData.classRatings || {};
                        systemSettings = backupData.systemSettings || systemSettings;
                        stars = backupData.stars || stars;
                        
                        saveData();
                        renderAttendance();
                        renderStars();
                        updateStatistics();
                        updateHeaderStars();
                        
                        showSuccessMessage('تم استعادة البيانات بنجاح');
                    }
                } catch (error) {
                    showErrorMessage('خطأ في قراءة ملف النسخة الاحتياطية');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('هل أنت متأكد من حذف جميع البيانات؟ لا يمكن التراجع عن هذا الإجراء.')) {
                teachers = [];
                classes = [];
                attendance = {};
                classRatings = {};
                stars = { dailyTeacher: null, weeklyTeacher: null, monthlyTeacher: null, dailyClass: null, weeklyClass: null, monthlyClass: null };
                
                saveData();
                renderAttendance();
                renderStars();
                updateStatistics();
                updateHeaderStars();
                
                showSuccessMessage('تم حذف جميع البيانات');
            }
        }

        function resetSystem() {
            if (confirm('هل أنت متأكد من إعادة تعيين النظام؟ سيتم حذف جميع البيانات وإعادة النظام للوضع الافتراضي.')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Render functions
        function renderAttendance() {
            const grid = document.getElementById('teachersGrid');
            
            if (teachers.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-500 text-lg col-span-full">لا توجد معلمات مضافات</p>';
                return;
            }
            
            grid.innerHTML = teachers.map(teacher => {
                const att = attendance[teacher.id];
                let statusClass = '';
                let statusText = 'لم يتم التسجيل';
                let buttons = '';
                
                if (att) {
                    if (att.status === 'present') {
                        statusClass = 'border-green-500 bg-green-50';
                        statusText = `حاضرة - ${att.time}`;
                        buttons = `
                            <button onclick="resetAttendance(${teacher.id})" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all duration-300 font-bold text-sm">
                                إعادة تعيين
                            </button>
                        `;
                    } else if (att.status === 'absent') {
                        statusClass = 'border-red-500 bg-red-50';
                        statusText = 'غائبة';
                        buttons = `
                            <button onclick="resetAttendance(${teacher.id})" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all duration-300 font-bold text-sm">
                                إعادة تعيين
                            </button>
                        `;
                    } else if (att.status === 'late') {
                        statusClass = 'border-orange-500 bg-orange-50';
                        statusText = `متأخرة - ${att.time}`;
                        buttons = `
                            <button onclick="resetAttendance(${teacher.id})" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all duration-300 font-bold text-sm">
                                إعادة تعيين
                            </button>
                        `;
                    } else if (att.status === 'excuse') {
                        statusClass = 'border-purple-500 bg-purple-50';
                        statusText = `عذر - ${att.time}`;
                        buttons = `
                            <button onclick="resetAttendance(${teacher.id})" 
                                class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-all duration-300 font-bold text-sm">
                                إعادة تعيين
                            </button>
                        `;
                    }
                } else {
                    buttons = `
                        <button onclick="markAttendance(${teacher.id}, 'present')" 
                            class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-all duration-300 font-bold text-sm mb-2">
                            تسجيل حضور
                        </button>
                        <button onclick="markAttendance(${teacher.id}, 'absent')" 
                            class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-all duration-300 font-bold text-sm mb-2">
                            تسجيل غياب
                        </button>
                        <button onclick="markAttendance(${teacher.id}, 'late')" 
                            class="w-full bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 transition-all duration-300 font-bold text-sm mb-2">
                            متأخرة
                        </button>
                        <button onclick="markAttendance(${teacher.id}, 'excuse')" 
                            class="w-full bg-purple-500 text-white py-2 rounded-lg hover:bg-purple-600 transition-all duration-300 font-bold text-sm mb-2">
                            عذر
                        </button>
                        <button onclick="openCameraModal()" 
                            class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-all duration-300 font-bold text-sm">
                            📷 تصوير الطابور
                        </button>
                    `;
                }
                
                return `
                    <div class="student-card ${statusClass} p-4 relative">
                        ${stars.dailyTeacher === teacher.id ? '<div class="absolute top-2 left-2 text-yellow-500 text-xl">⭐</div>' : ''}
                        
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-br from-purple-400 to-blue-500 flex items-center justify-center">
                                <i class="fas fa-user-tie text-2xl text-white"></i>
                            </div>
                            
                            <h4 class="text-lg font-bold mb-1">${teacher.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">المعلمة</p>
                            
                            <div class="mb-4">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${getAttendanceStatusColor(att?.status)}">${statusText}</span>
                            </div>
                            
                            <div class="space-y-2">
                                ${buttons}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateHeaderStars();
        }

        function renderStars() {
            const grid = document.getElementById('classRatingGrid');
            // Combine classes from teachers and standalone classes
            const teacherClasses = [...new Set(teachers.map(t => t.className))];
            const allClasses = [...new Set([...teacherClasses, ...classes])];
            
            if (allClasses.length === 0) {
                grid.innerHTML = '<p class="text-center text-gray-500 text-lg col-span-full">لا توجد صفوف للتقييم</p>';
                return;
            }
            
            grid.innerHTML = allClasses.map(className => {
                const rating = classRatings[className] || { speed: 0, quiet: 0, cleanliness: 0, total: 0 };
                
                return `
                    <div class="class-card p-6">
                        <div class="text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center">
                                <i class="fas fa-trophy text-2xl text-white"></i>
                            </div>
                            
                            <h3 class="text-xl font-bold mb-2">${className}</h3>
                            <p class="text-sm text-gray-600 mb-4">${className}</p>
                            
                            <div class="text-3xl font-bold text-yellow-600 mb-4">${rating.total}</div>
                            <div class="text-sm text-gray-600 mb-6">إجمالي النقاط</div>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-semibold">سرعة الاصطفاف</span>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <button onclick="updateClassRating('${className}', 'speed', -1)" 
                                            class="w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-all duration-300">
                                            -
                                        </button>
                                        <span class="w-8 text-center font-bold">${rating.speed}</span>
                                        <button onclick="updateClassRating('${className}', 'speed', 1)" 
                                            class="w-8 h-8 bg-green-500 text-white rounded-full hover:bg-green-600 transition-all duration-300">
                                            +
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-semibold">الهدوء والنظام</span>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <button onclick="updateClassRating('${className}', 'quiet', -1)" 
                                            class="w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-all duration-300">
                                            -
                                        </button>
                                        <span class="w-8 text-center font-bold">${rating.quiet}</span>
                                        <button onclick="updateClassRating('${className}', 'quiet', 1)" 
                                            class="w-8 h-8 bg-green-500 text-white rounded-full hover:bg-green-600 transition-all duration-300">
                                            +
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-semibold">النظافة الشخصية</span>
                                    <div class="flex items-center space-x-2 space-x-reverse">
                                        <button onclick="updateClassRating('${className}', 'cleanliness', -1)" 
                                            class="w-8 h-8 bg-red-500 text-white rounded-full hover:bg-red-600 transition-all duration-300">
                                            -
                                        </button>
                                        <span class="w-8 text-center font-bold">${rating.cleanliness}</span>
                                        <button onclick="updateClassRating('${className}', 'cleanliness', 1)" 
                                            class="w-8 h-8 bg-green-500 text-white rounded-full hover:bg-green-600 transition-all duration-300">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update functions
        function updateStatistics() {
            const presentCount = Object.values(attendance).filter(a => a.status === 'present' || a.status === 'late').length;
            const absentCount = Object.values(attendance).filter(a => a.status === 'absent').length;
            const excuseCount = Object.values(attendance).filter(a => a.status === 'excuse').length;
            const notMarkedCount = teachers.length - presentCount - absentCount - excuseCount;
            
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('notMarkedCount').textContent = notMarkedCount;
            document.getElementById('totalTeachers').textContent = teachers.length;
        }

        function updateStarSelects() {
            // Update teacher selects
            const dailyTeacherSelect = document.getElementById('dailyTeacherStar');
            const weeklyTeacherSelect = document.getElementById('weeklyTeacherStar');
            const monthlyTeacherSelect = document.getElementById('monthlyTeacherStar');
            
            if (dailyTeacherSelect) {
                dailyTeacherSelect.innerHTML = '<option value="">اختر المعلمة</option>';
                teachers.forEach(teacher => {
                    dailyTeacherSelect.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
                });
            }
            
            if (weeklyTeacherSelect) {
                weeklyTeacherSelect.innerHTML = '<option value="">اختر المعلمة</option>';
                teachers.forEach(teacher => {
                    weeklyTeacherSelect.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
                });
            }
            
            if (monthlyTeacherSelect) {
                monthlyTeacherSelect.innerHTML = '<option value="">اختر المعلمة</option>';
                teachers.forEach(teacher => {
                    monthlyTeacherSelect.innerHTML += `<option value="${teacher.id}">${teacher.name}</option>`;
                });
            }
            
            // Update class selects
            const dailyClassSelect = document.getElementById('dailyClassStar');
            const weeklyClassSelect = document.getElementById('weeklyClassStar');
            const monthlyClassSelect = document.getElementById('monthlyClassStar');
            // Combine classes from teachers and standalone classes
            const teacherClasses = [...new Set(teachers.map(t => t.className))];
            const allClasses = [...new Set([...teacherClasses, ...classes])];
            
            if (dailyClassSelect) {
                dailyClassSelect.innerHTML = '<option value="">اختر الصف</option>';
                allClasses.forEach(className => {
                    dailyClassSelect.innerHTML += `<option value="${className}">${className}</option>`;
                });
            }
            
            if (weeklyClassSelect) {
                weeklyClassSelect.innerHTML = '<option value="">اختر الصف</option>';
                allClasses.forEach(className => {
                    weeklyClassSelect.innerHTML += `<option value="${className}">${className}</option>`;
                });
            }
            
            if (monthlyClassSelect) {
                monthlyClassSelect.innerHTML = '<option value="">اختر الصف</option>';
                allClasses.forEach(className => {
                    monthlyClassSelect.innerHTML += `<option value="${className}">${className}</option>`;
                });
            }
        }

        // Utility functions
        function getAttendanceStatusColor(status) {
            const colors = {
                'present': 'bg-green-200 text-green-800',
                'absent': 'bg-red-200 text-red-800',
                'late': 'bg-orange-200 text-orange-800',
                'excuse': 'bg-purple-200 text-purple-800'
            };
            return colors[status] || 'bg-gray-200 text-gray-800';
        }

        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-6 right-6 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4 rounded-xl shadow-lg z-50 font-semibold';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-4 space-x-reverse">
                    <i class="fas fa-check-circle text-2xl"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.style.transform = 'translateX(100%)';
                setTimeout(() => successDiv.remove(), 400);
            }, 4000);
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-6 right-6 bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-4 rounded-xl shadow-lg z-50 font-semibold';
            errorDiv.innerHTML = `
                <div class="flex items-center space-x-4 space-x-reverse">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.style.transform = 'translateX(100%)';
                setTimeout(() => errorDiv.remove(), 400);
            }, 5000);
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('school_teachers', JSON.stringify(teachers));
            localStorage.setItem('school_classes', JSON.stringify(classes));
            localStorage.setItem('school_attendance', JSON.stringify(attendance));
            localStorage.setItem('school_class_ratings', JSON.stringify(classRatings));
            localStorage.setItem('school_system_settings', JSON.stringify(systemSettings));
            localStorage.setItem('school_stars', JSON.stringify(stars));
        }

        // Initialize the application when page loads
        window.onload = init;
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e9da3e47f6127a',t:'MTc1Nzc4OTY2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
